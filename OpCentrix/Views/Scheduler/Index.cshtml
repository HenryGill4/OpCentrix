@{
    ViewData["Title"] = "Scheduler";
}

<!-- Main Calendar Table -->
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2>Scheduler</h2>
        <form id="csvImportForm" enctype="multipart/form-data" style="display: flex; gap: 10px;">
            <input type="file" id="csvFile" accept=".csv" required />
            <button type="submit" style="padding: 8px 12px;">Import CSV</button>
        </form>
    </div>
    <div class="calendar-wrapper">
        <table class="calendar" id="calendar">
            <thead id="calendar-head"></thead>
            <tbody id="calendar-body"></tbody>
        </table>
    </div>
</div>


<!-- Add Print Modal -->
<div id="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 10;">
    <div style="background: var(--container-bg); padding: 20px; border-radius: 10px; width: 300px; max-width: 90%; color: var(--text-color);">
        <h3 style="margin-top: 0;">Add Print</h3>
        <label>Part:</label>
        <select id="modalPart"></select>
        <div id="suggestionBox" style="margin-bottom: 10px; font-size: 13px;"></div>

        <label>Estimated Duration (min):</label>
        <input type="number" id="modalDuration" readonly />
        <label>Start Time:</label>
        <input type="time" id="modalStartTime" />

        <input type="hidden" id="modalPrinter" />
        <input type="hidden" id="modalDate" />

        <button onclick="confirmAdd()">Add</button>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>

<!-- Edit/Delete Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 11;">
    <div style="background: var(--container-bg); padding: 20px; border-radius: 10px; width: 300px; max-width: 90%; color: var(--text-color);">
        <h3 style="margin-top: 0;">Edit Job</h3>
        <input type="hidden" id="editId" />

        <label>Part Number:</label>
        <input type="text" id="editPart" readonly />

        <label>Duration (min):</label>
        <input type="number" id="editDuration" />

        <button onclick="saveEdit()">Save</button>
        <button onclick="deleteJob()">Delete</button>
        <button onclick="closeEditModal()">Cancel</button>
    </div>
</div>

<!-- Load Scripts & Styles -->
<link rel="stylesheet" href="~/css/style.css" />
<script type="module">
    import { getLatestJobEndDate, generateCalendarDatesUntil, buildCalendarGrid, printers, today } from '/js/calendar.js';
    import { renderJobs } from '/js/jobs.js';
    import { addJob, confirmAdd, closeModal, openEditModal, closeEditModal, saveEdit, deleteJob } from '/js/modals.js';

    let dates = [];

    async function loadJobs() {
        const res = await fetch('/api/jobs');
        const jobs = await res.json();
        const latest = getLatestJobEndDate(jobs);
        dates = generateCalendarDatesUntil(latest);
        buildCalendarGrid(dates, addJob);
        renderJobs(jobs, dates, openEditModal);
    }

    window.addJob = addJob;
    window.openEditModal = openEditModal;
    window.closeModal = closeModal;
    window.confirmAdd = confirmAdd;
    window.closeEditModal = closeEditModal;
    window.saveEdit = saveEdit;
    window.deleteJob = deleteJob;

    loadJobs();
</script>


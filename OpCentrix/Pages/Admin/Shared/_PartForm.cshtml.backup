@model OpCentrix.Models.Part

<!-- Production-Ready Parts Form with Complete Stage Management -->
<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-cogs me-2"></i>
        @(Model.Id == 0 ? "Add New Part" : $"Edit Part: {Model.PartNumber}")
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- Production Parts Form with Stage Management -->
    <form method="post" id="partForm" asp-page-handler="@(Model.Id == 0 ? "Create" : "Update")" data-part-id="@Model.Id">
        <input type="hidden" asp-for="Id" />
        @if (Model.Id > 0)
        {
            <input type="hidden" asp-for="CreatedDate" />
            <input type="hidden" asp-for="CreatedBy" />
        }
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs nav-justified mb-3" id="partFormTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#basic" role="tab">
                    <i class="fas fa-info-circle me-1"></i>
                    <span class="d-none d-md-inline">Basic Information</span>
                    <span class="d-md-none">Basic</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stages-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#stages" role="tab">
                    <i class="fas fa-tasks me-1"></i>
                    <span class="d-none d-md-inline">Manufacturing Stages</span>
                    <span class="d-md-none">Stages</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#material" role="tab">
                    <i class="fas fa-flask me-1"></i>
                    <span class="d-none d-md-inline">Material & Process</span>
                    <span class="d-md-none">Material</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="physical-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#physical" role="tab">
                    <i class="fas fa-cube me-1"></i>
                    <span class="d-none d-md-inline">Physical Properties</span>
                    <span class="d-md-none">Physical</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#summary" role="tab">
                    <i class="fas fa-calculator me-1"></i>
                    <span class="d-none d-md-inline">Summary</span>
                    <span class="d-md-none">Summary</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="partFormTabsContent">
            
            <!-- TAB 1: Basic Information -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Essential Part Information
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="PartNumber" class="form-label required">Part Number</label>
                        <input asp-for="PartNumber" class="form-control" required 
                               placeholder="e.g., PT-001-2024" />
                        <span asp-validation-for="PartNumber" class="text-danger"></span>
                        <div class="form-text">Unique identifier for this part</div>
                    </div>
                    
                    <div class="col-md-8">
                        <label asp-for="Name" class="form-label required">Part Name</label>
                        <input asp-for="Name" class="form-control" required 
                               placeholder="e.g., Titanium Bracket Assembly" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Description" class="form-label required">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="3" required 
                                  placeholder="Detailed description of the part including specifications, applications, and special requirements..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="CustomerPartNumber" class="form-label">Customer Part Number</label>
                        <input asp-for="CustomerPartNumber" class="form-control" 
                               placeholder="Customer's internal part number" />
                        <span asp-validation-for="CustomerPartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Industry" class="form-label required">Industry</label>
                        <select asp-for="Industry" class="form-select" required>
                            <option value="">Select Industry</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Medical">Medical</option>
                            <option value="Defense">Defense</option>
                            <option value="Energy">Energy</option>
                            <option value="General Manufacturing">General Manufacturing</option>
                            <option value="Research & Development">Research & Development</option>
                        </select>
                        <span asp-validation-for="Industry" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Application" class="form-label required">Application</label>
                        <select asp-for="Application" class="form-select" required>
                            <option value="">Select Application</option>
                            <option value="General Component">General Component</option>
                            <option value="Structural Component">Structural Component</option>
                            <option value="Prototype Development">Prototype Development</option>
                            <option value="Production Tooling">Production Tooling</option>
                            <option value="Replacement Parts">Replacement Parts</option>
                            <option value="Custom Component">Custom Component</option>
                            <option value="Research & Testing">Research & Testing</option>
                        </select>
                        <span asp-validation-for="Application" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="PartCategory" class="form-label">Category</label>
                        <select asp-for="PartCategory" class="form-select">
                            <option value="Production">Production</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Repair">Repair</option>
                        </select>
                        <span asp-validation-for="PartCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="PartClass" class="form-label">Part Class</label>
                        <select asp-for="PartClass" class="form-select">
                            <option value="A">A - Critical (High Priority)</option>
                            <option value="B">B - Important (Medium Priority)</option>
                            <option value="C">C - Standard (Normal Priority)</option>
                        </select>
                        <span asp-validation-for="PartClass" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="IsActive" class="form-check-label">Active</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="IsAssemblyComponent" class="form-check-input" type="checkbox" />
                            <label asp-for="IsAssemblyComponent" class="form-check-label">Assembly Component</label>
                        </div>
                    </div>

                    <!-- Compliance Requirements -->
                    <div class="col-12 mt-4">
                        <h6 class="text-info border-bottom pb-2 mb-3">
                            <i class="fas fa-certificate me-2"></i>Compliance Requirements
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresFDA" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresFDA" class="form-check-label">
                                <i class="fas fa-shield-alt me-1"></i>FDA Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresAS9100" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresAS9100" class="form-check-label">
                                <i class="fas fa-certificate me-1"></i>AS9100 Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresNADCAP" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresNADCAP" class="form-check-label">
                                <i class="fas fa-award me-1"></i>NADCAP Compliance Required
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Manufacturing Stages -->
            <div class="tab-pane fade" id="stages" role="tabpanel">
                @await Html.PartialAsync("_PartStagesManager", Model)
            </div>
            
            <!-- TAB 3: Material & Process -->
            <div class="tab-pane fade" id="material" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-flask me-2"></i>Material Selection & Process Parameters
                        </h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Material" class="form-label required">Primary Material</label>
                        <select asp-for="Material" class="form-select" id="materialSelect" 
                                onchange="window.updateSlsMaterial && window.updateSlsMaterial()" required>
                            <option value="">Select Material</option>
                            <optgroup label="Titanium Alloys">
                                <option value="Ti-6Al-4V Grade 5">Ti-6Al-4V Grade 5 (Standard)</option>
                                <option value="Ti-6Al-4V ELI Grade 23">Ti-6Al-4V ELI Grade 23 (Medical)</option>
                                <option value="CP Titanium Grade 2">CP Titanium Grade 2</option>
                            </optgroup>
                            <optgroup label="Nickel Superalloys">
                                <option value="Inconel 718">Inconel 718 (High Temperature)</option>
                                <option value="Inconel 625">Inconel 625 (Corrosion Resistant)</option>
                            </optgroup>
                            <optgroup label="Stainless Steels">
                                <option value="316L Stainless Steel">316L Stainless Steel</option>
                                <option value="17-4 PH Stainless Steel">17-4 PH Stainless Steel</option>
                            </optgroup>
                            <optgroup label="Aluminum Alloys">
                                <option value="AlSi10Mg">AlSi10Mg (Lightweight)</option>
                            </optgroup>
                        </select>
                        <span asp-validation-for="Material" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="SlsMaterial" class="form-label">SLS Processing Material</label>
                        <input asp-for="SlsMaterial" class="form-control" id="slsMaterialInput" />
                        <span asp-validation-for="SlsMaterial" class="text-danger"></span>
                        <div class="form-text">Auto-filled from material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="ProcessType" class="form-label">Primary Process Type</label>
                        <select asp-for="ProcessType" class="form-select">
                            <option value="SLS Metal">SLS Metal</option>
                            <option value="SLS Polymer">SLS Polymer</option>
                            <option value="DMLS">DMLS</option>
                            <option value="EBM">EBM</option>
                            <option value="CNC">CNC Machining</option>
                            <option value="EDM">EDM</option>
                        </select>
                        <span asp-validation-for="ProcessType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="SurfaceFinishRequirement" class="form-label">Surface Finish Requirement</label>
                        <select asp-for="SurfaceFinishRequirement" class="form-select">
                            <option value="As-built">As-built</option>
                            <option value="Machined">Machined</option>
                            <option value="Polished">Polished</option>
                            <option value="Sandblasted">Sandblasted</option>
                            <option value="Coated">Coated</option>
                            <option value="Anodized">Anodized</option>
                        </select>
                        <span asp-validation-for="SurfaceFinishRequirement" class="text-danger"></span>
                    </div>
                    
                    <!-- Base Time Estimate (Fallback) -->
                    <div class="col-md-6">
                        <label asp-for="EstimatedHours" class="form-label">Base Estimated Hours</label>
                        <input asp-for="EstimatedHours" type="number" step="0.1" min="0.1" class="form-control" />
                        <span asp-validation-for="EstimatedHours" class="text-danger"></span>
                        <div class="form-text">Used if no manufacturing stages are configured</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="MaterialCostPerKg" class="form-label">Material Cost ($/kg)</label>
                        <input asp-for="MaterialCostPerKg" type="number" step="0.01" class="form-control" />
                        <span asp-validation-for="MaterialCostPerKg" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 4: Physical Properties -->
            <div class="tab-pane fade" id="physical" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-cube me-2"></i>Physical Properties & Dimensions
                        </h6>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="LengthMm" class="form-label">Length (mm)</label>
                        <input asp-for="LengthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="LengthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="WidthMm" class="form-label">Width (mm)</label>
                        <input asp-for="WidthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="WidthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="HeightMm" class="form-label">Height (mm)</label>
                        <input asp-for="HeightMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="HeightMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="WeightGrams" class="form-label">Weight (g)</label>
                        <input asp-for="WeightGrams" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" />
                        <span asp-validation-for="WeightGrams" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="VolumeMm3" class="form-label">Volume (mm³)</label>
                        <input asp-for="VolumeMm3" type="number" step="1" class="form-control" 
                               id="volumeInput" readonly />
                        <span asp-validation-for="VolumeMm3" class="text-danger"></span>
                        <div class="form-text">Auto-calculated from L × W × H</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Dimensions" class="form-label">Dimensions String</label>
                        <input asp-for="Dimensions" class="form-control" 
                               placeholder="e.g., 100 × 50 × 25 mm" id="dimensionsInput" readonly />
                        <span asp-validation-for="Dimensions" class="text-danger"></span>
                        <div class="form-text">Auto-generated from dimensions</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="MaxSurfaceRoughnessRa" class="form-label">Max Surface Roughness Ra (µm)</label>
                        <input asp-for="MaxSurfaceRoughnessRa" type="number" step="0.1" class="form-control" 
                               placeholder="25.0" />
                        <span asp-validation-for="MaxSurfaceRoughnessRa" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: Summary -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-calculator me-2"></i>Manufacturing Summary
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Stage-Based Calculations:</strong> These values are automatically calculated from your selected manufacturing stages.
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-tasks fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-stages">0</h4>
                                <small>Manufacturing Stages</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-duration">0.0h</h4>
                                <small>Total Duration</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-cost">$0.00</h4>
                                <small>Estimated Cost</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-complexity">Simple</h4>
                                <small>Complexity Level</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Breakdown -->
                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Stage-by-Stage Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="stage-breakdown-table">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>No stages configured yet.</p>
                                        <p class="small">Go to the Manufacturing Stages tab to configure stages for this part.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Administrative Override Section -->
                    <div class="col-12 mt-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-shield me-2"></i>Administrative Override (Optional)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label asp-for="AdminEstimatedHoursOverride" class="form-label">Duration Override (hours)</label>
                                        <input asp-for="AdminEstimatedHoursOverride" type="number" step="0.1" min="0.1" 
                                               class="form-control" id="adminOverrideInput" />
                                        <span asp-validation-for="AdminEstimatedHoursOverride" class="text-danger"></span>
                                        <div class="form-text">Leave blank to use calculated value</div>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <label asp-for="AdminOverrideReason" class="form-label">Override Justification</label>
                                        <textarea asp-for="AdminOverrideReason" class="form-control" rows="2" 
                                                  placeholder="Required when using override values..." 
                                                  id="overrideReasonText"></textarea>
                                        <span asp-validation-for="AdminOverrideReason" class="text-danger"></span>
                                        <div class="form-text text-danger">Required when override hours are specified</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Cancel
    </button>
    <button type="submit" form="partForm" class="btn btn-primary" id="savePartBtn">
        <i class="fas fa-save me-1"></i>
        <span class="btn-text">@(Model.Id == 0 ? "Create Part" : "Update Part")</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button>
</div>

<script>
// Production-Ready Parts Form JavaScript
(function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
        initializePartsForm();
    });
    
    function initializePartsForm() {
        try {
            setupTabs();
            setupStageAwareTotalsUpdating();
            setupMaterialAutoFill();
            setupVolumeCalculation();
            setupAdminOverrideValidation();
        } catch (error) {
            console.error('Error initializing parts form:', error);
        }
    }
    
    function setupTabs() {
        const tabTriggers = document.querySelectorAll('[data-bs-toggle="tab"]');
        
        tabTriggers.forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active classes
                document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding tab content
                const targetId = this.getAttribute('data-bs-target');
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            });
        });
    }
    
    function setupStageAwareTotalsUpdating() {
        document.addEventListener('stageConfigurationChanged', function(event) {
            const stageData = event.detail;
            updateTotalsSummary(stageData);
        });
    }
    
    function updateTotalsSummary(stagesData) {
        try {
            const totalStagesEl = document.getElementById('summary-total-stages');
            const totalDurationEl = document.getElementById('summary-total-duration');
            const totalCostEl = document.getElementById('summary-total-cost');
            const complexityEl = document.getElementById('summary-complexity');
            
            if (!stagesData || stagesData.size === 0) {
                if (totalStagesEl) totalStagesEl.textContent = '0';
                if (totalDurationEl) totalDurationEl.textContent = '0.0h';
                if (totalCostEl) totalCostEl.textContent = '$0.00';
                if (complexityEl) complexityEl.textContent = 'Simple';
                updateStageBreakdownTable([]);
                return;
            }
            
            const stageData = window.selectedStageData;
            if (stageData) {
                if (totalStagesEl) totalStagesEl.textContent = stageData.stages.size;
                if (totalDurationEl) totalDurationEl.textContent = `${stageData.totalDuration.toFixed(1)}h`;
                if (totalCostEl) totalCostEl.textContent = `$${stageData.totalCost.toFixed(2)}`;
                if (complexityEl) {
                    complexityEl.textContent = stageData.complexityLevel;
                }
                
                const sortedStages = Array.from(stageData.stages.entries())
                    .sort(([, a], [, b]) => a.executionOrder - b.executionOrder);
                updateStageBreakdownTable(sortedStages);
            }
        } catch (error) {
            console.error('Error updating totals summary:', error);
        }
    }
    
    function updateStageBreakdownTable(sortedStages) {
        const tableContainer = document.getElementById('stage-breakdown-table');
        if (!tableContainer) return;
        
        if (sortedStages.length === 0) {
            tableContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>No stages configured yet.</p>
                    <p class="small">Go to the Manufacturing Stages tab to configure stages for this part.</p>
                </div>
            `;
            return;
        }
        
        const availableStages = window.availableStages || [];
        
        const tableHtml = `
            <table class="table table-sm">
                <thead class="table-light">
                    <tr>
                        <th width="60">Order</th>
                        <th>Stage</th>
                        <th width="100">Duration</th>
                        <th width="100">Setup</th>
                        <th width="120">Est. Cost</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedStages.map(([stageId, stageData]) => {
                        const stage = availableStages.find(s => s.id === parseInt(stageId));
                        const hourlyRate = stageData.hourlyRateOverride || stage?.defaultHourlyRate || 85;
                        const setupCost = (stageData.setupTimeMinutes / 60) * hourlyRate;
                        const laborCost = stageData.estimatedHours * hourlyRate;
                        const totalStageCost = setupCost + laborCost + stageData.materialCost;
                        
                        return `
                            <tr>
                                <td>
                                    <span class="badge" style="background-color: ${stage?.stageColor || '#007bff'};">
                                        ${stageData.executionOrder}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="${stage?.stageIcon || 'fas fa-cogs'} me-2" style="color: ${stage?.stageColor || '#007bff'};"></i>
                                        <strong>${stageData.name}</strong>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <strong>${stageData.estimatedHours}h</strong>
                                </td>
                                <td class="text-center">
                                    ${stageData.setupTimeMinutes} min
                                </td>
                                <td class="text-end">
                                    <strong>$${totalStageCost.toFixed(2)}</strong>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        tableContainer.innerHTML = tableHtml;
    }
    
    function setupMaterialAutoFill() {
        const materialSelect = document.getElementById('materialSelect');
        if (materialSelect) {
            materialSelect.addEventListener('change', function() {
                window.updateSlsMaterial && window.updateSlsMaterial();
            });
        }
    }
    
    function setupVolumeCalculation() {
        const lengthInput = document.querySelector('input[name="LengthMm"]');
        const widthInput = document.querySelector('input[name="WidthMm"]');
        const heightInput = document.querySelector('input[name="HeightMm"]');
        
        if (lengthInput && widthInput && heightInput) {
            [lengthInput, widthInput, heightInput].forEach(input => {
                input.addEventListener('change', window.calculateVolume);
            });
        }
    }
    
    function setupAdminOverrideValidation() {
        const overrideInput = document.getElementById('adminOverrideInput');
        const reasonTextarea = document.getElementById('overrideReasonText');
        
        if (overrideInput && reasonTextarea) {
            overrideInput.addEventListener('input', function() {
                const hasOverride = parseFloat(this.value) > 0;
                reasonTextarea.required = hasOverride;
            });
        }
    }
    
    // Global utility functions
    window.updateSlsMaterial = function() {
        const materialSelect = document.getElementById('materialSelect');
        const slsMaterialInput = document.getElementById('slsMaterialInput');
        
        if (materialSelect && slsMaterialInput) {
            slsMaterialInput.value = materialSelect.value;
        }
    };
    
    window.calculateVolume = function() {
        const lengthInput = document.querySelector('input[name="LengthMm"]');
        const widthInput = document.querySelector('input[name="WidthMm"]');
        const heightInput = document.querySelector('input[name="HeightMm"]');
        const volumeInput = document.getElementById('volumeInput');
        const dimensionsInput = document.getElementById('dimensionsInput');
        
        if (lengthInput && widthInput && heightInput && volumeInput && dimensionsInput) {
            const length = parseFloat(lengthInput.value) || 0;
            const width = parseFloat(widthInput.value) || 0;
            const height = parseFloat(heightInput.value) || 0;
            
            if (length > 0 && width > 0 && height > 0) {
                const volume = length * width * height;
                volumeInput.value = Math.round(volume);
                dimensionsInput.value = `${length} × ${width} × ${height} mm`;
            } else {
                volumeInput.value = '';
                dimensionsInput.value = '';
            }
        }
    };
})();
</script>

<style>
    .required:after {
        content: " *";
        color: red;
    }
    
    .tab-pane {
        min-height: 400px;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
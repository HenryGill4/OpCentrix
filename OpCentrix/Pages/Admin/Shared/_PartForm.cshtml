@model OpCentrix.Pages.Admin.PartsModel

<!-- Production-Ready Parts Form with Complete Stage Management -->
<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-cogs me-2"></i>
        @(Model.Part.Id == 0 ? "Add New Part" : $"Edit Part: {Model.Part.PartNumber}")
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    @if (ViewData.ModelState.Any(ms => ms.Value?.Errors.Count > 0))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Please fix the following errors:</strong>
            <ul class="mb-0 mt-2">
                @foreach (var error in ViewData.ModelState.SelectMany(ms => ms.Value?.Errors ?? new Microsoft.AspNetCore.Mvc.ModelBinding.ModelErrorCollection()))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Production Parts Form with Stage Management -->
    <form method="post" id="partForm" 
          hx-post="/Admin/Parts?handler=@(Model.Part.Id == 0 ? "Create" : "Update")"
          hx-target="#partModalContent"
          hx-swap="outerHTML"
          hx-encoding="multipart/form-data"
          hx-on::after-request="handleFormResponse(event)"
          data-part-id="@Model.Part.Id">
        
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Part.Id" />
        @if (Model.Part.Id > 0)
        {
            <input type="hidden" asp-for="Part.CreatedDate" />
            <input type="hidden" asp-for="Part.CreatedBy" />
        }
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs nav-justified mb-3" id="partFormTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#basic" role="tab">
                    <i class="fas fa-info-circle me-1"></i>
                    <span class="d-none d-md-inline">Basic Information</span>
                    <span class="d-md-none">Basic</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stages-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#stages" role="tab">
                    <i class="fas fa-tasks me-1"></i>
                    <span class="d-none d-md-inline">Manufacturing Stages</span>
                    <span class="d-md-none">Stages</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#material" role="tab">
                    <i class="fas fa-flask me-1"></i>
                    <span class="d-none d-md-inline">Material & Process</span>
                    <span class="d-md-none">Material</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="physical-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#physical" role="tab">
                    <i class="fas fa-cube me-1"></i>
                    <span class="d-none d-md-inline">Physical Properties</span>
                    <span class="d-md-none">Physical</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bt-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#bt" role="tab">
                    <i class="fas fa-shield-alt me-1"></i>
                    <span class="d-none d-md-inline">B&T Compliance</span>
                    <span class="d-md-none">B&T</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#summary" role="tab">
                    <i class="fas fa-calculator me-1"></i>
                    <span class="d-none d-md-inline">Summary</span>
                    <span class="d-md-none">Summary</span>
                </button>
            </li>
            <!-- Phase 5: Asset Management Tab -->
            @if (Model.Part.Id > 0)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assets-tab" type="button" 
                            data-bs-toggle="tab" data-bs-target="#assets" role="tab">
                        <i class="fas fa-paperclip me-1"></i>
                        <span class="d-none d-md-inline">Assets</span>
                        <span class="d-md-none">Files</span>
                    </button>
                </li>
            }
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="partFormTabsContent">
            
            <!-- TAB 1: Basic Information -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Essential Part Information
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.PartNumber" class="form-label required">Part Number</label>
                        <input asp-for="Part.PartNumber" class="form-control" required 
                               placeholder="e.g., BT-SUP-001" />
                        <span asp-validation-for="Part.PartNumber" class="text-danger"></span>
                        <div class="form-text">Unique identifier for this part</div>
                    </div>
                    
                    <div class="col-md-8">
                        <label asp-for="Part.Name" class="form-label required">Part Name</label>
                        <input asp-for="Part.Name" class="form-control" required 
                               placeholder="e.g., B&T Suppressor Baffle Stack" />
                        <span asp-validation-for="Part.Name" class="text-danger"></span>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Part.Description" class="form-label required">Description</label>
                        <textarea asp-for="Part.Description" class="form-control" rows="3" required 
                                  placeholder="Detailed description of the part including specifications, applications, and special requirements..."></textarea>
                        <span asp-validation-for="Part.Description" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.CustomerPartNumber" class="form-label">Customer Part Number</label>
                        <input asp-for="Part.CustomerPartNumber" class="form-control" 
                               placeholder="Customer's internal part number" />
                        <span asp-validation-for="Part.CustomerPartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Industry" class="form-label required">Industry</label>
                        <select asp-for="Part.Industry" class="form-select" required>
                            <option value="">Select Industry</option>
                            <option value="Firearms">Firearms</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Medical">Medical</option>
                            <option value="Defense">Defense</option>
                            <option value="Energy">Energy</option>
                            <option value="General Manufacturing">General Manufacturing</option>
                            <option value="Research & Development">Research & Development</option>
                        </select>
                        <span asp-validation-for="Part.Industry" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Application" class="form-label required">Application</label>
                        <select asp-for="Part.Application" class="form-select" required>
                            <option value="">Select Application</option>
                            <option value="B&T Manufacturing">B&T Manufacturing</option>
                            <option value="General Component">General Component</option>
                            <option value="Structural Component">Structural Component</option>
                            <option value="Prototype Development">Prototype Development</option>
                            <option value="Production Tooling">Production Tooling</option>
                            <option value="Replacement Parts">Replacement Parts</option>
                            <option value="Custom Component">Custom Component</option>
                            <option value="Research & Testing">Research & Testing</option>
                        </select>
                        <span asp-validation-for="Part.Application" class="text-danger"></span>
                    </div>

                    <!-- PHASE 3: New Lookup Fields -->
                    <div class="col-md-6">
                        <label asp-for="Part.ComponentTypeId" class="form-label required">Component Type</label>
                        <select asp-for="Part.ComponentTypeId" class="form-select" required>
                            <option value="">Select Component Type</option>
                            @if (Model.PartFormData?.ComponentTypes != null)
                            {
                                @foreach (var componentType in Model.PartFormData.ComponentTypes)
                                {
                                    <option value="@componentType.Id">@componentType.Name - @componentType.Description</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="Part.ComponentTypeId" class="text-danger"></span>
                        <div class="form-text">Determines serialization and tracking requirements</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ComplianceCategoryId" class="form-label required">Compliance Category</label>
                        <select asp-for="Part.ComplianceCategoryId" class="form-select" required>
                            <option value="">Select Compliance Category</option>
                            @if (Model.PartFormData?.ComplianceCategories != null)
                            {
                                @foreach (var category in Model.PartFormData.ComplianceCategories)
                                {
                                    <option value="@category.Id" data-regulatory-level="@category.RegulatoryLevel">
                                        @category.Name (@category.RegulatoryLevel)
                                        @if (category.RequiresSpecialHandling) 
                                        { 
                                            <span>- Special Handling Required</span> 
                                        }
                                    </option>
                                }
                            }
                        </select>
                        <span asp-validation-for="Part.ComplianceCategoryId" class="text-danger"></span>
                        <div class="form-text">Regulatory compliance level and requirements</div>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartCategory" class="form-label">Category</label>
                        <select asp-for="Part.PartCategory" class="form-select">
                            <option value="Production">Production</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Repair">Repair</option>
                        </select>
                        <span asp-validation-for="Part.PartCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartClass" class="form-label">Part Class</label>
                        <select asp-for="Part.PartClass" class="form-select">
                            <option value="A">A - Critical (High Priority)</option>
                            <option value="B">B - Important (Medium Priority)</option>
                            <option value="C">C - Standard (Normal Priority)</option>
                        </select>
                        <span asp-validation-for="Part.PartClass" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="Part.IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.IsActive" class="form-check-label">Active</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="Part.IsAssemblyComponent" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.IsAssemblyComponent" class="form-check-label">Assembly Component</label>
                        </div>
                    </div>

                    <!-- Quality Standards -->
                    <div class="col-12 mt-4">
                        <h6 class="text-info border-bottom pb-2 mb-3">
                            <i class="fas fa-certificate me-2"></i>Quality Standards
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresFDA" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresFDA" class="form-check-label">
                                <i class="fas fa-shield-alt me-1"></i>FDA Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresAS9100" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresAS9100" class="form-check-label">
                                <i class="fas fa-certificate me-1"></i>AS9100 Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresNADCAP" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresNADCAP" class="form-check-label">
                                <i class="fas fa-award me-1"></i>NADCAP Compliance Required
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Manufacturing Stages -->
            <div class="tab-pane fade" id="stages" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-tasks me-2"></i>Manufacturing Process Stages
                        </h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ManufacturingStage" class="form-label">Current Stage</label>
                        <select asp-for="Part.ManufacturingStage" class="form-select">
                            <option value="Design">Design</option>
                            <option value="SLS-Primary">SLS Primary</option>
                            <option value="Secondary-Ops">Secondary Operations</option>
                            <option value="Multi-Stage">Multi-Stage</option>
                            <option value="Assembly">Assembly</option>
                            <option value="Finishing">Finishing</option>
                            <option value="Complete">Complete</option>
                        </select>
                        <span asp-validation-for="Part.ManufacturingStage" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.StageOrder" class="form-label">Stage Order</label>
                        <input asp-for="Part.StageOrder" type="number" min="1" max="10" class="form-control" />
                        <span asp-validation-for="Part.StageOrder" class="text-danger"></span>
                    </div>
                    
                    <!-- PHASE 4: Modern Stage Management -->
                    <!-- Legacy boolean checkboxes removed - now using PartStageRequirements -->
                    <div class="col-12 mt-4">
                        <h6 class="text-info">Manufacturing Stages</h6>
                        <p class="text-muted">Manufacturing stages are now managed through the modern stage system. Use the Manufacturing Stages tab to configure detailed stage requirements, timing, and costs.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Enhanced Stage Management:</strong> The new system provides granular control over each manufacturing stage including setup times, execution order, hourly rates, and material costs.
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Part.StageDetails" class="form-label">Stage Details (JSON)</label>
                        <textarea asp-for="Part.StageDetails" class="form-control" rows="3" 
                                  placeholder='{"setup_time": 30, "special_requirements": "..."}'></textarea>
                        <span asp-validation-for="Part.StageDetails" class="text-danger"></span>
                        <div class="form-text">JSON format for stage-specific parameters</div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: Material & Process -->
            <div class="tab-pane fade" id="material" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-flask me-2"></i>Material Selection & Process Parameters
                        </h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.Material" class="form-label required">Primary Material</label>
                        <select asp-for="Part.Material" class="form-select" id="materialSelect" 
                                onchange="window.updateSlsMaterial && window.updateSlsMaterial()" required>
                            <option value="">Select Material</option>
                            <optgroup label="Titanium Alloys">
                                <option value="Ti-6Al-4V Grade 5">Ti-6Al-4V Grade 5 (Standard)</option>
                                <option value="Ti-6Al-4V ELI Grade 23">Ti-6Al-4V ELI Grade 23 (Medical)</option>
                                <option value="CP Titanium Grade 2">CP Titanium Grade 2</option>
                            </optgroup>
                            <optgroup label="Nickel Superalloys">
                                <option value="Inconel 718">Inconel 718 (High Temperature)</option>
                                <option value="Inconel 625">Inconel 625 (Corrosion Resistant)</option>
                            </optgroup>
                            <optgroup label="Stainless Steels">
                                <option value="316L Stainless Steel">316L Stainless Steel</option>
                                <option value="17-4 PH Stainless Steel">17-4 PH Stainless Steel</option>
                            </optgroup>
                            <optgroup label="Aluminum Alloys">
                                <option value="AlSi10Mg">AlSi10Mg (Lightweight)</option>
                            </optgroup>
                        </select>
                        <span asp-validation-for="Part.Material" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.SlsMaterial" class="form-label">SLS Processing Material</label>
                        <input asp-for="Part.SlsMaterial" class="form-control" id="slsMaterialInput" />
                        <span asp-validation-for="Part.SlsMaterial" class="text-danger"></span>
                        <div class="form-text">Auto-filled from material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ProcessType" class="form-label">Primary Process Type</label>
                        <select asp-for="Part.ProcessType" class="form-select">
                            <option value="SLS Metal">SLS Metal</option>
                            <option value="SLS Polymer">SLS Polymer</option>
                            <option value="DMLS">DMLS</option>
                            <option value="EBM">EBM</option>
                            <option value="CNC">CNC Machining</option>
                            <option value="EDM">EDM</option>
                        </select>
                        <span asp-validation-for="Part.ProcessType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.SurfaceFinishRequirement" class="form-label">Surface Finish Requirement</label>
                        <select asp-for="Part.SurfaceFinishRequirement" class="form-select">
                            <option value="As-built">As-built</option>
                            <option value="Machined">Machined</option>
                            <option value="Polished">Polished</option>
                            <option value="Sandblasted">Sandblasted</option>
                            <option value="Coated">Coated</option>
                            <option value="Anodized">Anodized</option>
                        </select>
                        <span asp-validation-for="Part.SurfaceFinishRequirement" class="text-danger"></span>
                    </div>
                    
                    <!-- Time & Cost Estimates -->
                    <div class="col-12 mt-4">
                        <h6 class="text-info">Time & Cost Estimates</h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.EstimatedHours" class="form-label required">Estimated Hours</label>
                        <input asp-for="Part.EstimatedHours" type="number" step="0.1" min="0.1" class="form-control" required />
                        <span asp-validation-for="Part.EstimatedHours" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.MaterialCostPerKg" class="form-label">Material Cost ($/kg)</label>
                        <input asp-for="Part.MaterialCostPerKg" type="number" step="0.01" class="form-control" />
                        <span asp-validation-for="Part.MaterialCostPerKg" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.StandardLaborCostPerHour" class="form-label">Labor Cost ($/hour)</label>
                        <input asp-for="Part.StandardLaborCostPerHour" type="number" step="0.01" class="form-control" />
                        <span asp-validation-for="Part.StandardLaborCostPerHour" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- TAB 4: Physical Properties -->
            <div class="tab-pane fade" id="physical" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-cube me-2"></i>Physical Properties & Dimensions
                        </h6>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.LengthMm" class="form-label">Length (mm)</label>
                        <input asp-for="Part.LengthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="Part.LengthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.WidthMm" class="form-label">Width (mm)</label>
                        <input asp-for="Part.WidthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="Part.WidthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.HeightMm" class="form-label">Height (mm)</label>
                        <input asp-for="Part.HeightMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="Part.HeightMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.WeightGrams" class="form-label">Weight (g)</label>
                        <input asp-for="Part.WeightGrams" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" />
                        <span asp-validation-for="Part.WeightGrams" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.VolumeMm3" class="form-label">Volume (mm³)</label>
                        <input asp-for="Part.VolumeMm3" type="number" step="1" class="form-control" 
                               id="volumeInput" readonly />
                        <span asp-validation-for="Part.VolumeMm3" class="text-danger"></span>
                        <div class="form-text">Auto-calculated from L × W × H</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.Dimensions" class="form-label">Dimensions String</label>
                        <input asp-for="Part.Dimensions" class="form-control" 
                               placeholder="e.g., 100 × 50 × 25 mm" id="dimensionsInput" readonly />
                        <span asp-validation-for="Part.Dimensions" class="text-danger"></span>
                        <div class="form-text">Auto-generated from dimensions</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.MaxSurfaceRoughnessRa" class="form-label">Max Surface Roughness Ra (μm)</label>
                        <input asp-for="Part.MaxSurfaceRoughnessRa" type="number" step="0.1" class="form-control" />
                        <span asp-validation-for="Part.MaxSurfaceRoughnessRa" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- TAB 5: B&T Compliance -->
            <div class="tab-pane fade" id="bt" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-shield-alt me-2"></i>B&T Manufacturing & Compliance
                        </h6>
                    </div>
                    
                    <!-- B&T Component Classification -->
                    <div class="col-12">
                        <h6 class="text-info">Component Classification</h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.BTComponentType" class="form-label">B&T Component Type</label>
                        <select asp-for="Part.BTComponentType" class="form-select">
                            <option value="General">General</option>
                            <option value="Suppressor">Suppressor</option>
                            <option value="Receiver">Receiver</option>
                            <option value="Barrel">Barrel</option>
                            <option value="Trigger">Trigger</option>
                            <option value="Safety">Safety</option>
                        </select>
                        <span asp-validation-for="Part.BTComponentType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.BTFirearmCategory" class="form-label">Firearm Category</label>
                        <select asp-for="Part.BTFirearmCategory" class="form-select">
                            <option value="Component">Component</option>
                            <option value="Firearm">Firearm</option>
                            <option value="NFA_Item">NFA Item</option>
                            <option value="Accessory">Accessory</option>
                        </select>
                        <span asp-validation-for="Part.BTFirearmCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.BTSuppressorType" class="form-label">Suppressor Type</label>
                        <select asp-for="Part.BTSuppressorType" class="form-select">
                            <option value="">Not a Suppressor</option>
                            <option value="Baffle">Baffle</option>
                            <option value="EndCap">End Cap</option>
                            <option value="Tube">Tube</option>
                            <option value="Mount">Mount</option>
                            <option value="Internal">Internal</option>
                        </select>
                        <span asp-validation-for="Part.BTSuppressorType" class="text-danger"></span>
                    </div>
                    
                    <!-- Regulatory Compliance -->
                    <div class="col-12 mt-4">
                        <h6 class="text-warning">Regulatory Compliance</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input asp-for="Part.RequiresATFForm1" class="form-check-input" type="checkbox" />
                                    <label asp-for="Part.RequiresATFForm1" class="form-check-label">
                                        <i class="fas fa-file-alt me-1"></i>Requires ATF Form 1
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input asp-for="Part.RequiresATFForm4" class="form-check-input" type="checkbox" />
                                    <label asp-for="Part.RequiresATFForm4" class="form-check-label">
                                        <i class="fas fa-file-alt me-1"></i>Requires ATF Form 4
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input asp-for="Part.RequiresTaxStamp" class="form-check-input" type="checkbox" />
                                    <label asp-for="Part.RequiresTaxStamp" class="form-check-label">
                                        <i class="fas fa-stamp me-1"></i>Requires Tax Stamp
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input asp-for="Part.RequiresExportLicense" class="form-check-input" type="checkbox" />
                                    <label asp-for="Part.RequiresExportLicense" class="form-check-label">
                                        <i class="fas fa-globe me-1"></i>Requires Export License
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ATFClassification" class="form-label">ATF Classification</label>
                        <input asp-for="Part.ATFClassification" class="form-control" 
                               placeholder="e.g., Firearm, Silencer, SBR, etc." />
                        <span asp-validation-for="Part.ATFClassification" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.TaxStampAmount" class="form-label">Tax Stamp Amount ($)</label>
                        <input asp-for="Part.TaxStampAmount" type="number" step="0.01" class="form-control" 
                               placeholder="200.00" />
                        <span asp-validation-for="Part.TaxStampAmount" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- TAB 6: Summary -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-calculator me-2"></i>Manufacturing Summary
                        </h6>
                    </div
                    >
                    <!-- Summary Cards -->
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-tasks fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-stages">0</h4>
                                <small>Manufacturing Stages</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-duration">0.0h</h4>
                                <small>Estimated Duration</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-cost">$0.00</h4>
                                <small>Estimated Cost</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-complexity">Simple</h4>
                                <small>Complexity Level</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Administrative Override Section -->
                    <div class="col-12 mt-4">
                        <div class="card border-warning admin-override-section">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-shield me-2"></i>Administrative Override (Optional)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label asp-for="Part.AdminEstimatedHoursOverride" class="form-label">Duration Override (hours)</label>
                                        <input asp-for="Part.AdminEstimatedHoursOverride" type="number" step="0.1" min="0.1" 
                                               class="form-control" id="adminOverrideInput" />
                                        <span asp-validation-for="Part.AdminEstimatedHoursOverride" class="text-danger"></span>
                                        <div class="form-text">Leave blank to use calculated value</div>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <label asp-for="Part.AdminOverrideReason" class="form-label">Override Justification</label>
                                        <textarea asp-for="Part.AdminOverrideReason" class="form-control" rows="2" 
                                                  placeholder="Required when using override values..." 
                                                  id="overrideReasonText"></textarea>
                                        <span asp-validation-for="Part.AdminOverrideReason" class="text-danger"></span>
                                        <div class="form-text text-danger">Required when override hours are specified</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 7: Assets (Phase 5) -->
            @if (Model.Part.Id > 0)
            {
                <div class="tab-pane fade" id="assets" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-paperclip me-2"></i>Part Assets & Documentation
                            </h6>
                        </div>
                        
                        <!-- Upload Section -->
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New Asset</h6>
                                </div>
                                <div class="card-body">
                                    <form id="assetUploadForm" enctype="multipart/form-data" onsubmit="return uploadAsset(event)">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label">Asset Type</label>
                                                <select id="assetType" class="form-select" onchange="updateFileTypeInfo()">
                                                    <option value="3DModel">3D Model</option>
                                                    <option value="Photo">Photo</option>
                                                    <option value="Drawing">Technical Drawing</option>
                                                    <option value="Document">Document</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Display Name</label>
                                                <input type="text" id="assetDisplayName" class="form-control" 
                                                       placeholder="Enter descriptive name" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">File</label>
                                                <input type="file" id="assetFile" class="form-control" 
                                                       onchange="updateDisplayName()" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="fas fa-upload me-1"></i>Upload
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <small class="text-muted" id="fileTypeInfo">
                                                    Supported: .step, .stp, .stl, .obj, .3mf, .ply | Max size: 100MB
                                                </small>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Existing Assets Section -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-folder-open me-2"></i>Existing Assets</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshAssets()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                                <div class="card-body" id="assetsContainer">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Loading assets...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Asset Statistics -->
                        <div class="col-12">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-cube fa-2x mb-2"></i>
                                            <h4 class="mb-0" id="stat-3dmodels">0</h4>
                                            <small>3D Models</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-image fa-2x mb-2"></i>
                                            <h4 class="mb-0" id="stat-photos">0</h4>
                                            <small>Photos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-drafting-compass fa-2x mb-2"></i>
                                            <h4 class="mb-0" id="stat-drawings">0</h4>
                                            <small>Drawings</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                                            <h4 class="mb-0" id="stat-documents">0</h4>
                                            <small>Documents</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Cancel
    </button>
    <button type="submit" form="partForm" class="btn btn-primary" id="savePartBtn">
        <i class="fas fa-save me-1"></i>
        <span class="btn-text">@(Model.Part.Id == 0 ? "Create Part" : "Update Part")</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button>
</div>

<!-- Include External CSS -->
<link rel="stylesheet" href="~/css/admin/parts-form.css" asp-append-version="true" />

<!-- Include External JavaScript -->
<script src="~/js/admin/parts-form.js" asp-append-version="true"></script>

<!-- Phase 5: Asset Management JavaScript -->
<script>
// Asset Management Functionality
const AssetManager = {
    partId: @Model.Part.Id,
    
    // File type information
    fileTypes: {
        '3DModel': {
            extensions: ['.step', '.stp', '.stl', '.obj', '.3mf', '.ply'],
            maxSize: 100,
            icon: 'fas fa-cube'
        },
        'Photo': {
            extensions: ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.webp'],
            maxSize: 10,
            icon: 'fas fa-image'
        },
        'Drawing': {
            extensions: ['.pdf', '.dwg', '.dxf', '.svg'],
            maxSize: 25,
            icon: 'fas fa-drafting-compass'
        },
        'Document': {
            extensions: ['.pdf', '.docx', '.xlsx', '.txt', '.md'],
            maxSize: 5,
            icon: 'fas fa-file-alt'
        }
    },

    init() {
        if (this.partId > 0) {
            this.loadAssets();
            this.updateFileTypeInfo();
        }
    },

    async loadAssets() {
        try {
            const response = await fetch(`/Admin/Parts?handler=PartAssets&partId=${this.partId}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            this.renderAssets(data.assets);
            this.updateStatistics(data.statistics);
        } catch (error) {
            console.error('Error loading assets:', error);
            this.showError('Failed to load assets');
        }
    },

    renderAssets(assets) {
        const container = document.getElementById('assetsContainer');
        
        if (!assets || assets.length === 0) {
            container.innerHTML =`
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No assets uploaded yet</p>
                    <small class="text-muted">Use the upload form above to add 3D models, photos, or documents</small>
                </div>
            `;
            return;
        }

        const assetsByType = this.groupAssetsByType(assets);
        let html = '';

        for (const [type, typeAssets] of Object.entries(assetsByType)) {
            if (typeAssets.length === 0) continue;

            const typeInfo = this.fileTypes[type];
            html += `
                <div class="asset-group mb-4">
                    <h6 class="text-secondary">
                        <i class="${typeInfo.icon} me-2"></i>${type}s (${typeAssets.length})
                    </h6>
                    <div class="row g-2">
            `;

            typeAssets.forEach(asset => {
                html += this.renderAssetCard(asset);
            });

            html += `
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    },

    renderAssetCard(asset) {
        const typeInfo = this.fileTypes[asset.assetType];
        const isImage = asset.assetType === 'Photo';
        
        return `
            <div class="col-md-4 col-lg-3">
                <div class="card asset-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <i class="${typeInfo.icon} fa-2x text-primary"></i>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="${asset.url}" target="_blank">
                                        <i class="fas fa-eye me-2"></i>View
                                    </a></li>
                                    <li><a class="dropdown-item" href="${asset.url}" download>
                                        <i class="fas fa-download me-2"></i>Download
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" 
                                           onclick="AssetManager.deleteAsset(${asset.id})">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        ${isImage ? `<img src="${asset.url}" class="img-fluid rounded mb-2" style="max-height: 100px; width: 100%; object-fit: cover;" alt="${asset.displayName}">` : ''}
                        <h6 class="card-title mb-1" title="${asset.displayName}">${this.truncateText(asset.displayName, 20)}</h6>
                        <small class="text-muted d-block">${asset.fileExtension.toUpperCase()}</small>
                        <small class="text-muted">${new Date(asset.createdDate).toLocaleDateString()}</small>
                    </div>
                </div>
            </div>
        `;
    },

    groupAssetsByType(assets) {
        const grouped = {
            '3DModel': [],
            'Photo': [],
            'Drawing': [],
            'Document': []
        };

        assets.forEach(asset => {
            if (grouped[asset.assetType]) {
                grouped[asset.assetType].push(asset);
            }
        });

        return grouped;
    },

    updateStatistics(stats) {
        document.getElementById('stat-3dmodels').textContent = stats['3DModel'] || 0;
        document.getElementById('stat-photos').textContent = stats['Photo'] || 0;
        document.getElementById('stat-drawings').textContent = stats['Drawing'] || 0;
        document.getElementById('stat-documents').textContent = stats['Document'] || 0;
    },

    updateFileTypeInfo() {
        const assetType = document.getElementById('assetType').value;
        const typeInfo = this.fileTypes[assetType];
        
        document.getElementById('fileTypeInfo').textContent = 
            `Supported: ${typeInfo.extensions.join(', ')} | Max size: ${typeInfo.maxSize}MB`;
    },

    updateDisplayName() {
        const fileInput = document.getElementById('assetFile');
        const displayNameInput = document.getElementById('assetDisplayName');
        
        if (fileInput.files.length > 0 && !displayNameInput.value) {
            const fileName = fileInput.files[0].name;
            displayNameInput.value = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
        }
    },

    async deleteAsset(assetId) {
        if (!confirm('Are you sure you want to delete this asset?')) return;

        try {
            const formData = new FormData();
            formData.append('assetId', assetId);

            const response = await fetch('/Admin/Parts?handler=DeleteAsset', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: formData
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const result = await response.json();
            if (result.success) {
                this.showSuccess('Asset deleted successfully');
                this.loadAssets(); // Refresh the list
            } else {
                this.showError(result.message || 'Failed to delete asset');
            }
        } catch (error) {
            console.error('Error deleting asset:', error);
            this.showError('Failed to delete asset');
        }
    },

    truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    },

    showSuccess(message) {
        // You can implement toast notifications here
        console.log('Success:', message);
    },

    showError(message) {
        // You can implement toast notifications here
        console.error('Error:', message);
    }
};

// Upload asset function
async function uploadAsset(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('assetFile');
    const assetType = document.getElementById('assetType').value;
    const displayName = document.getElementById('assetDisplayName').value;
    
    if (!fileInput.files.length) {
        AssetManager.showError('Please select a file');
        return false;
    }
    
    if (!displayName) {
        AssetManager.showError('Please enter a display name');
        return false;
    }

    try {
        const formData = new FormData();
        formData.append('partId', AssetManager.partId);
        formData.append('assetFile', fileInput.files[0]);
        formData.append('assetType', assetType);
        formData.append('displayName', displayName);

        const submitButton = event.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';

        const response = await fetch('/Admin/Parts?handler=UploadAsset', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: formData
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
            AssetManager.showSuccess('Asset uploaded successfully');
            document.getElementById('assetUploadForm').reset();
            AssetManager.updateFileTypeInfo();
            AssetManager.loadAssets(); // Refresh the list
        } else {
            AssetManager.showError(result.message || 'Failed to upload asset');
        }
    } catch (error) {
        console.error('Error uploading asset:', error);
        AssetManager.showError('Failed to upload asset');
    } finally {
        const submitButton = event.target.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-upload me-1"></i>Upload';
    }
    
    return false;
}

function updateFileTypeInfo() {
    AssetManager.updateFileTypeInfo();
}

function updateDisplayName() {
    AssetManager.updateDisplayName();
}

function refreshAssets() {
    AssetManager.loadAssets();
}

// Initialize asset manager when page loads
document.addEventListener('DOMContentLoaded', function() {
    AssetManager.init();
});
</script>
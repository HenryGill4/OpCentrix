@model OpCentrix.Models.Part

<!-- Enhanced, Dynamic Parts Form with Stage-Based Workflow -->
<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-cogs me-2"></i>
        @(Model.Id == 0 ? "Add New Part" : $"Edit Part: {Model.PartNumber}")
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <!-- Enhanced form with dynamic stage management -->
    <form method="post" id="partForm" asp-page-handler="@(Model.Id == 0 ? "Create" : "Update")" data-part-id="@Model.Id">
        <input type="hidden" asp-for="Id" />
        @if (Model.Id > 0)
        {
            <input type="hidden" asp-for="CreatedDate" />
            <input type="hidden" asp-for="CreatedBy" />
        }
        
        <!-- Dynamic Tab Navigation -->
        <ul class="nav nav-tabs nav-justified mb-3" id="partFormTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#basic" role="tab">
                    <i class="fas fa-info-circle me-1"></i>
                    <span class="d-none d-md-inline">Basic Info</span>
                    <span class="d-md-none">Basic</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stages-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#stages" role="tab">
                    <i class="fas fa-tasks me-1"></i>
                    <span class="d-none d-md-inline">Manufacturing Stages</span>
                    <span class="d-md-none">Stages</span>
                </button>
            </li>
            <!-- Dynamic stage tabs will be inserted here -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#material" role="tab">
                    <i class="fas fa-flask me-1"></i>
                    <span class="d-none d-md-inline">Material & Process</span>
                    <span class="d-md-none">Material</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="physical-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#physical" role="tab">
                    <i class="fas fa-cube me-1"></i>
                    <span class="d-none d-md-inline">Physical Properties</span>
                    <span class="d-md-none">Physical</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="totals-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#totals" role="tab">
                    <i class="fas fa-calculator me-1"></i>
                    <span class="d-none d-md-inline">Summary & Totals</span>
                    <span class="d-md-none">Totals</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab" type="button" 
                        data-bs-toggle="tab" data-bs-target="#admin" role="tab">
                    <i class="fas fa-user-shield me-1"></i>
                    <span class="d-none d-md-inline">Admin Override</span>
                    <span class="d-md-none">Admin</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content Container -->
        <div class="tab-content" id="partFormTabsContent">
            
            <!-- TAB 1: Basic Information (Simplified) -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Essential Part Information
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>New Approach:</strong> Define your part's basic information here, then configure specific manufacturing stages in the next tab. Each stage will store its own detailed requirements.
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="PartNumber" class="form-label required">Part Number</label>
                        <input asp-for="PartNumber" class="form-control" required 
                               placeholder="e.g., PT-001-2024" 
                               onblur="window.validatePartNumber && window.validatePartNumber(this.value)" />
                        <span asp-validation-for="PartNumber" class="text-danger"></span>
                        <div class="form-text">Unique identifier for this part</div>
                    </div>
                    
                    <div class="col-md-8">
                        <label asp-for="Name" class="form-label required">Part Name</label>
                        <input asp-for="Name" class="form-control" required 
                               placeholder="e.g., Titanium Bracket Assembly" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Description" class="form-label required">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="3" required 
                                  placeholder="Detailed description of the part including specifications, applications, and special requirements..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="CustomerPartNumber" class="form-label">Customer Part Number</label>
                        <input asp-for="CustomerPartNumber" class="form-control" 
                               placeholder="Customer's internal part number" />
                        <span asp-validation-for="CustomerPartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Industry" class="form-label required">Industry</label>
                        <select asp-for="Industry" class="form-select" required>
                            <option value="">Select Industry</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Medical">Medical</option>
                            <option value="Defense">Defense</option>
                            <option value="Energy">Energy</option>
                            <option value="General Manufacturing">General Manufacturing</option>
                            <option value="Research & Development">Research & Development</option>
                        </select>
                        <span asp-validation-for="Industry" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Application" class="form-label required">Application</label>
                        <select asp-for="Application" class="form-select" required>
                            <option value="">Select Application</option>
                            <option value="General Component">General Component</option>
                            <option value="Structural Component">Structural Component</option>
                            <option value="Prototype Development">Prototype Development</option>
                            <option value="Production Tooling">Production Tooling</option>
                            <option value="Replacement Parts">Replacement Parts</option>
                            <option value="Custom Component">Custom Component</option>
                            <option value="Research & Testing">Research & Testing</option>
                        </select>
                        <span asp-validation-for="Application" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="PartCategory" class="form-label">Category</label>
                        <select asp-for="PartCategory" class="form-select">
                            <option value="Production">Production</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Repair">Repair</option>
                        </select>
                        <span asp-validation-for="PartCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="PartClass" class="form-label">Part Class</label>
                        <select asp-for="PartClass" class="form-select">
                            <option value="A">A - Critical (High Priority)</option>
                            <option value="B">B - Important (Medium Priority)</option>
                            <option value="C">C - Standard (Normal Priority)</option>
                        </select>
                        <span asp-validation-for="PartClass" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="IsActive" class="form-check-label">Active</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input asp-for="IsAssemblyComponent" class="form-check-input" type="checkbox" />
                            <label asp-for="IsAssemblyComponent" class="form-check-label">Assembly Component</label>
                        </div>
                    </div>

                    <!-- Compliance Requirements -->
                    <div class="col-12 mt-4">
                        <h6 class="text-info border-bottom pb-2 mb-3">
                            <i class="fas fa-certificate me-2"></i>Compliance Requirements
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresFDA" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresFDA" class="form-check-label">
                                <i class="fas fa-shield-alt me-1"></i>FDA Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresAS9100" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresAS9100" class="form-check-label">
                                <i class="fas fa-certificate me-1"></i>AS9100 Compliance Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="RequiresNADCAP" class="form-check-input" type="checkbox" />
                            <label asp-for="RequiresNADCAP" class="form-check-label">
                                <i class="fas fa-award me-1"></i>NADCAP Compliance Required
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Manufacturing Stages (NEW DYNAMIC APPROACH) -->
            <div class="tab-pane fade" id="stages" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-tasks me-2"></i>Manufacturing Stage Assignment
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Dynamic Stage Management:</strong> Select the stages required for this part. Each selected stage will create its own configuration tab with custom fields and parameters.
                        </div>
                    </div>
                </div>
                
                @await Html.PartialAsync("_PartStagesManager", Model)
            </div>
            
            <!-- TAB 3: Material & Process (Simplified) -->
            <div class="tab-pane fade" id="material" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-flask me-2"></i>Base Material Selection
                        </h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Detailed process parameters are now configured per-stage. This section defines the base material properties.
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Material" class="form-label required">Primary Material</label>
                        <select asp-for="Material" class="form-select" id="materialSelect" 
                                onchange="window.updateSlsMaterial && window.updateSlsMaterial()" required>
                            <option value="">Select Material</option>
                            <optgroup label="Titanium Alloys">
                                <option value="Ti-6Al-4V Grade 5">Ti-6Al-4V Grade 5 (Standard)</option>
                                <option value="Ti-6Al-4V ELI Grade 23">Ti-6Al-4V ELI Grade 23 (Medical)</option>
                                <option value="CP Titanium Grade 2">CP Titanium Grade 2</option>
                            </optgroup>
                            <optgroup label="Nickel Superalloys">
                                <option value="Inconel 718">Inconel 718 (High Temperature)</option>
                                <option value="Inconel 625">Inconel 625 (Corrosion Resistant)</option>
                            </optgroup>
                            <optgroup label="Stainless Steels">
                                <option value="316L Stainless Steel">316L Stainless Steel</option>
                                <option value="17-4 PH Stainless Steel">17-4 PH Stainless Steel</option>
                            </optgroup>
                            <optgroup label="Aluminum Alloys">
                                <option value="AlSi10Mg">AlSi10Mg (Lightweight)</option>
                            </optgroup>
                        </select>
                        <span asp-validation-for="Material" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="SlsMaterial" class="form-label">SLS Processing Material</label>
                        <input asp-for="SlsMaterial" class="form-control" id="slsMaterialInput" />
                        <span asp-validation-for="SlsMaterial" class="text-danger"></span>
                        <div class="form-text">Auto-filled from material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="ProcessType" class="form-label">Primary Process Type</label>
                        <select asp-for="ProcessType" class="form-select">
                            <option value="SLS Metal">SLS Metal</option>
                            <option value="SLS Polymer">SLS Polymer</option>
                            <option value="DMLS">DMLS</option>
                            <option value="EBM">EBM</option>
                            <option value="CNC">CNC Machining</option>
                            <option value="EDM">EDM</option>
                        </select>
                        <span asp-validation-for="ProcessType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="SurfaceFinishRequirement" class="form-label">Surface Finish Requirement</label>
                        <select asp-for="SurfaceFinishRequirement" class="form-select">
                            <option value="As-built">As-built</option>
                            <option value="Machined">Machined</option>
                            <option value="Polished">Polished</option>
                            <option value="Sandblasted">Sandblasted</option>
                            <option value="Coated">Coated</option>
                            <option value="Anodized">Anodized</option>
                        </select>
                        <span asp-validation-for="SurfaceFinishRequirement" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 4: Physical Properties -->
            <div class="tab-pane fade" id="physical" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-cube me-2"></i>Physical Properties & Dimensions
                        </h6>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="LengthMm" class="form-label">Length (mm)</label>
                        <input asp-for="LengthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="LengthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="WidthMm" class="form-label">Width (mm)</label>
                        <input asp-for="WidthMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="WidthMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="HeightMm" class="form-label">Height (mm)</label>
                        <input asp-for="HeightMm" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" onchange="window.calculateVolume && window.calculateVolume()" />
                        <span asp-validation-for="HeightMm" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="WeightGrams" class="form-label">Weight (g)</label>
                        <input asp-for="WeightGrams" type="number" step="0.1" class="form-control" 
                               placeholder="0.0" />
                        <span asp-validation-for="WeightGrams" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="VolumeMm3" class="form-label">Volume (mm³)</label>
                        <input asp-for="VolumeMm3" type="number" step="1" class="form-control" 
                               id="volumeInput" readonly />
                        <span asp-validation-for="VolumeMm3" class="text-danger"></span>
                        <div class="form-text">Auto-calculated from L × W × H</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Dimensions" class="form-label">Dimensions String</label>
                        <input asp-for="Dimensions" class="form-control" 
                               placeholder="e.g., 100 × 50 × 25 mm" id="dimensionsInput" readonly />
                        <span asp-validation-for="Dimensions" class="text-danger"></span>
                        <div class="form-text">Auto-generated from dimensions</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="MaxSurfaceRoughnessRa" class="form-label">Max Surface Roughness Ra (µm)</label>
                        <input asp-for="MaxSurfaceRoughnessRa" type="number" step="0.1" class="form-control" 
                               placeholder="25.0" />
                        <span asp-validation-for="MaxSurfaceRoughnessRa" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: NEW - Summary & Totals -->
            <div class="tab-pane fade" id="totals" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-calculator me-2"></i>Manufacturing Summary & Totals
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Calculated from Stages:</strong> These totals are automatically calculated from your selected manufacturing stages and their configurations.
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-tasks fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-stages">0</h4>
                                <small>Manufacturing Stages</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-total-duration">0.0h</h4>
                                <small>Total Duration</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
    <div class="card bg-success text-white">
        <div class="card-body text-center">
            <i class="fas fa-dollar-sign fa-2x mb-2"></i>
            <h4 class="mb-0" id="summary-total-cost">$0.00</h4>
            <small>Estimated Cost</small>
        </div>
    </div>
</div>
                    
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-2x mb-2"></i>
                                <h4 class="mb-0" id="summary-complexity">Simple</h4>
                                <small>Complexity Level</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Breakdown -->
                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Stage-by-Stage Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="stage-breakdown-table">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>No stages selected yet.</p>
                                        <p class="small">Go to the Manufacturing Stages tab to configure stages for this part.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Material Summary -->
                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-flask me-2"></i>Material Requirements Summary
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="material-summary">
                                    <div class="text-center text-muted">
                                        <p>Material requirements will be calculated from stage configurations.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 6: Admin Override (Enhanced) -->
            <div class="tab-pane fade" id="admin" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-user-shield me-2"></i>Administrative Override Controls
                        </h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Admin Override:</strong> These fields allow administrators to override calculated values from stage configurations. Use with caution and always provide justification.
                        </div>
                    </div>
                    
                    <!-- Pre-populated from stage calculations -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Calculated from Stages</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Calculated Duration</label>
                                    <div class="form-control-plaintext bg-light border rounded p-2" id="calculated-duration">
                                        0.0 hours
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Calculated Cost</label>
                                    <div class="form-control-plaintext bg-light border rounded p-2" id="calculated-cost">
                                        $0.00
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stage Configuration</label>
                                    <div class="form-control-plaintext bg-light border rounded p-2" id="stage-configuration">
                                        No stages configured
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Administrative Overrides</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="AdminEstimatedHoursOverride" class="form-label">Duration Override (hours)</label>
                                    <input asp-for="AdminEstimatedHoursOverride" type="number" step="0.1" min="0.1" 
                                           class="form-control" onchange="window.updateDurationDisplay && window.updateDurationDisplay()" 
                                           id="adminOverrideInput" />
                                    <span asp-validation-for="AdminEstimatedHoursOverride" class="text-danger"></span>
                                    <div class="form-text">Leave blank to use calculated value</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Cost Override ($)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" 
                                           placeholder="Leave blank to use calculated cost" />
                                    <div class="form-text">Override total calculated cost</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="AdminOverrideReason" class="form-label">Override Justification *</label>
                                    <textarea asp-for="AdminOverrideReason" class="form-control" rows="3" 
                                              placeholder="Required: Explain why overrides are necessary..." 
                                              id="overrideReasonText"></textarea>
                                    <span asp-validation-for="AdminOverrideReason" class="text-danger"></span>
                                    <div class="form-text text-danger">Required when using any override values</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legacy fields for basic estimates -->
                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>Base Estimates (Used if no stages configured)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label asp-for="EstimatedHours" class="form-label">Fallback Estimated Hours</label>
                                            <input asp-for="EstimatedHours" type="number" step="0.1" min="0.1" class="form-control" 
                                                   id="estimatedHoursInput" />
                                            <span asp-validation-for="EstimatedHours" class="text-danger"></span>
                                            <div class="form-text">Used only if no manufacturing stages are defined</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label asp-for="MaterialCostPerKg" class="form-label">Material Cost ($/kg)</label>
                                            <input asp-for="MaterialCostPerKg" type="number" step="0.01" class="form-control" 
                                                   placeholder="450.00" />
                                            <span asp-validation-for="MaterialCostPerKg" class="text-danger"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label asp-for="StandardLaborCostPerHour" class="form-label">Labor Rate ($/hr)</label>
                                            <input asp-for="StandardLaborCostPerHour" type="number" step="0.01" class="form-control" 
                                                   placeholder="85.00" />
                                            <span asp-validation-for="StandardLaborCostPerHour" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Cancel
    </button>
    <button type="submit" form="partForm" class="btn btn-primary" id="savePartBtn">
        <i class="fas fa-save me-1"></i>
        <span class="btn-text">@(Model.Id == 0 ? "Create Part" : "Update Part")</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button>
</div>

<script>
    console.log('?? [PART-FORM] Loading enhanced dynamic parts form');
    
    // Initialize enhanced part form
    document.addEventListener('DOMContentLoaded', function() {
        console.log('?? [PART-FORM] Initializing enhanced part form with stage management');
        
        // Setup event listeners for stage-aware totals updating
        setupStageAwareTotalsUpdating();
        
        // Initialize material auto-fill
        setupMaterialAutoFill();
        
        // Setup volume calculation
        setupVolumeCalculation();
        
        // Setup admin override validation
        setupAdminOverrideValidation();
        
        console.log('? [PART-FORM] Enhanced part form initialized');
    });
    
    // Setup stage-aware totals updating
    function setupStageAwareTotalsUpdating() {
        // Listen for stage changes from the stage manager component
        document.addEventListener('stageConfigurationChanged', function(event) {
            const stageData = event.detail;
            console.log('?? [PART-FORM] Stage configuration changed, updating totals', stageData);
            
            updateTotalsSummary(stageData);
            updateAdminCalculatedValues(stageData);
            updateDynamicStageTabs(stageData);
        });
    }
    
    // Update dynamic stage tabs based on selected stages
    function updateDynamicStageTabs(stagesData) {
        const tabsList = document.getElementById('partFormTabs');
        const tabsContent = document.getElementById('partFormTabsContent');
        
        if (!tabsList || !tabsContent) return;
        
        // Remove existing dynamic stage tabs
        const existingDynamicTabs = tabsList.querySelectorAll('.dynamic-stage-tab');
        existingDynamicTabs.forEach(tab => tab.remove());
        
        const existingDynamicPanes = tabsContent.querySelectorAll('.dynamic-stage-pane');
        existingDynamicPanes.forEach(pane => pane.remove());
        
        if (!stagesData || stagesData.size === 0) return;
        
        // Sort stages by execution order
        const sortedStages = Array.from(stagesData.entries())
            .sort(([, a], [, b]) => a.executionOrder - b.executionOrder);
        
        // Find insertion point (after stages tab, before material tab)
        const stagesTab = document.getElementById('stages-tab').parentElement;
        const materialTab = document.getElementById('material-tab').parentElement;
        
        // Create tabs and panes for each selected stage
        sortedStages.forEach(([stageId, stageData], index) => {
            const stage = window.availableStages?.find(s => s.id === parseInt(stageId));
            if (!stage) return;
            
            // Create tab
            const tabId = `stage-${stageId}-tab`;
            const paneId = `stage-${stageId}-pane`;
            
            const tabElement = document.createElement('li');
            tabElement.className = 'nav-item dynamic-stage-tab';
            tabElement.setAttribute('role', 'presentation');
            tabElement.innerHTML = `
                <button class="nav-link" id="${tabId}" type="button" 
                        data-bs-toggle="tab" data-bs-target="#${paneId}" role="tab">
                    <i class="${stage.stageIcon || 'fas fa-cogs'} me-1" style="color: ${stage.stageColor || '#007bff'};"></i>
                    <span class="d-none d-md-inline">${stageData.name}</span>
                    <span class="d-md-none">#${stageData.executionOrder}</span>
                </button>
            `;
            
            // Insert tab after stages tab
            tabsList.insertBefore(tabElement, materialTab);
            
            // Create pane with custom fields
            const customFields = stage.customFields || [];
            const customFieldsHtml = customFields.length > 0 ? 
                generateStageCustomFieldsForm(stageId, customFields, stageData.customFieldValues || {}) : 
                '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No custom fields configured for this stage.</div>';
            
            const paneElement = document.createElement('div');
            paneElement.className = 'tab-pane fade dynamic-stage-pane';
            paneElement.id = paneId;
            paneElement.setAttribute('role', 'tabpanel');
            paneElement.innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="${stage.stageIcon || 'fas fa-cogs'} fa-2x me-3" style="color: ${stage.stageColor || '#007bff'};"></i>
                            <div>
                                <h5 class="mb-1" style="color: ${stage.stageColor || '#007bff'};">${stageData.name}</h5>
                                <p class="text-muted mb-0">Stage ${stageData.executionOrder} - ${stage.department || 'Manufacturing'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stage Configuration Summary -->
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>Stage Configuration
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Duration (hours)</label>
                                        <input type="number" step="0.1" min="0.1" class="form-control stage-duration-input" 
                                               value="${stageData.estimatedHours}" data-stage-id="${stageId}"
                                               onchange="updateStageParameter(${stageId}, 'estimatedHours', this.value)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Setup Time (minutes)</label>
                                        <input type="number" min="0" class="form-control stage-setup-input" 
                                               value="${stageData.setupTimeMinutes}" data-stage-id="${stageId}"
                                               onchange="updateStageParameter(${stageId}, 'setupTimeMinutes', this.value)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Hourly Rate ($)</label>
                                        <input type="number" step="0.01" min="0" class="form-control stage-rate-input" 
                                               value="${stageData.hourlyRateOverride || stage.defaultHourlyRate || 85}" data-stage-id="${stageId}"
                                               onchange="updateStageParameter(${stageId}, 'hourlyRateOverride', this.value)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Material Cost ($)</label>
                                        <input type="number" step="0.01" min="0" class="form-control stage-material-input" 
                                               value="${stageData.materialCost || 0}" data-stage-id="${stageId}"
                                               onchange="updateStageParameter(${stageId}, 'materialCost', this.value)">
                                    </div>
                                </div>
                                
                                ${stage.requiresMachineAssignment ? `
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Assigned Machine</label>
                                            <select class="form-select stage-machine-select" data-stage-id="${stageId}"
                                                    onchange="updateStageParameter(${stageId}, 'assignedMachineId', this.value)">
                                                <option value="">Select Machine</option>
                                                ${(window.availableMachines || []).map(machine => `
                                                    <option value="${machine.machineId}" ${stageData.assignedMachineId === machine.machineId ? 'selected' : ''}>
                                                        ${machine.machineId} - ${machine.name}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mt-4">
                                                <input type="checkbox" class="form-check-input" 
                                                       ${stageData.allowParallelExecution ? 'checked' : ''} data-stage-id="${stageId}"
                                                       onchange="updateStageParameter(${stageId}, 'allowParallelExecution', this.checked)">
                                                <label class="form-check-label">Allow parallel execution</label>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <label class="form-label">Special Instructions</label>
                                        <textarea class="form-control stage-instructions-input" rows="2" data-stage-id="${stageId}"
                                                  placeholder="Any special instructions for this stage..."
                                                  onchange="updateStageParameter(${stageId}, 'specialInstructions', this.value)">${stageData.specialInstructions || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Fields Section -->
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-wrench me-2"></i>Stage-Specific Fields
                                </h6>
                            </div>
                            <div class="card-body">
                                ${customFieldsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert pane after stages pane
            const stagesPane = document.getElementById('stages');
            tabsContent.insertBefore(paneElement, stagesPane.nextElementSibling);
        });
        
        console.log(`?? [PART-FORM] Created ${sortedStages.length} dynamic stage tabs`);
    }
    
    // Generate custom fields form for a stage
    function generateStageCustomFieldsForm(stageId, customFields, currentValues) {
        if (!customFields || customFields.length === 0) {
            return '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No custom fields configured for this stage.</div>';
        }
        
        return customFields.map(field => {
            const fieldId = `stage-${stageId}-field-${field.Name}`;
            const currentValue = currentValues[field.Name] || field.DefaultValue || '';
            
            let inputHtml = '';
            
            switch (field.Type) {
                case 'number':
                    inputHtml = `
                        <input type="number" class="form-control stage-custom-field" 
                               id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                               value="${currentValue}" ${field.Required ? 'required' : ''}
                               ${field.MinValue !== null ? `min="${field.MinValue}"` : ''}
                               ${field.MaxValue !== null ? `max="${field.MaxValue}"` : ''}
                               placeholder="${field.PlaceholderText || ''}"
                               onchange="updateStageCustomField(${stageId}, '${field.Name}', this.value)">
                        ${field.Unit ? `<div class="form-text">Unit: ${field.Unit}</div>` : ''}
                    `;
                    break;
                    
                case 'dropdown':
                    inputHtml = `
                        <select class="form-select stage-custom-field" 
                                id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                                ${field.Required ? 'required' : ''}
                                onchange="updateStageCustomField(${stageId}, '${field.Name}', this.value)">
                            <option value="">Select ${field.Label}</option>
                            ${(field.Options || []).map(option => `
                                <option value="${option}" ${currentValue === option ? 'selected' : ''}>${option}</option>
                            `).join('')}
                        </select>
                    `;
                    break;
                    
                case 'checkbox':
                    inputHtml = `
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input stage-custom-field" 
                                   id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                                   ${currentValue === 'true' || currentValue === true ? 'checked' : ''}
                                   onchange="updateStageCustomField(${stageId}, '${field.Name}', this.checked)">
                            <label class="form-check-label" for="${fieldId}">${field.Label}</label>
                        </div>
                    `;
                    break;
                    
                case 'textarea':
                    inputHtml = `
                        <textarea class="form-control stage-custom-field" 
                                  id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                                  rows="3" ${field.Required ? 'required' : ''}
                                  placeholder="${field.PlaceholderText || ''}"
                                  onchange="updateStageCustomField(${stageId}, '${field.Name}', this.value)">${currentValue}</textarea>
                    `;
                    break;
                    
                case 'date':
                    inputHtml = `
                        <input type="date" class="form-control stage-custom-field" 
                               id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                               value="${currentValue}" ${field.Required ? 'required' : ''}
                               onchange="updateStageCustomField(${stageId}, '${field.Name}', this.value)">
                    `;
                    break;
                    
                default: // text
                    inputHtml = `
                        <input type="text" class="form-control stage-custom-field" 
                               id="${fieldId}" data-stage-id="${stageId}" data-field-name="${field.Name}"
                               value="${currentValue}" ${field.Required ? 'required' : ''}
                               placeholder="${field.PlaceholderText || ''}"
                               onchange="updateStageCustomField(${stageId}, '${field.Name}', this.value)">
                    `;
                    break;
            }
            
            if (field.Type !== 'checkbox') {
                return `
                    <div class="mb-3">
                        <label class="form-label" for="${fieldId}">
                            ${field.Label} ${field.Required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        ${inputHtml}
                        ${field.Description ? `<div class="form-text">${field.Description}</div>` : ''}
                    </div>
                `;
            } else {
                return `<div class="mb-3">${inputHtml}</div>`;
            }
        }).join('');
    }
    
    // Update stage parameter
    window.updateStageParameter = function(stageId, parameterName, value) {
        // This function will be called when stage parameters change
        // Trigger stage configuration change event
        const event = new CustomEvent('stageParameterChanged', {
            detail: { stageId, parameterName, value }
        });
        document.dispatchEvent(event);
    };
    
    // Update stage custom field
    window.updateStageCustomField = function(stageId, fieldName, value) {
        // This function will be called when custom fields change
        const event = new CustomEvent('stageCustomFieldChanged', {
            detail: { stageId, fieldName, value }
        });
        document.dispatchEvent(event);
    };
    
    // Listen for stage parameter and custom field changes
    document.addEventListener('stageParameterChanged', function(event) {
        const { stageId, parameterName, value } = event.detail;
        
        // Update the selectedStages data
        if (window.selectedStageData && window.selectedStageData.stages && window.selectedStageData.stages.has(stageId)) {
            const stageData = window.selectedStageData.stages.get(stageId);
            stageData[parameterName] = value;
            
            // Trigger update of totals and dynamic tabs
            const updateEvent = new CustomEvent('stageConfigurationChanged', {
                detail: window.selectedStageData.stages
            });
            document.dispatchEvent(updateEvent);
        }
    });
    
    document.addEventListener('stageCustomFieldChanged', function(event) {
        const { stageId, fieldName, value } = event.detail;
        
        // Update the selectedStages data
        if (window.selectedStageData && window.selectedStageData.stages && window.selectedStageData.stages.has(stageId)) {
            const stageData = window.selectedStageData.stages.get(stageId);
            if (!stageData.customFieldValues) {
                stageData.customFieldValues = {};
            }
            stageData.customFieldValues[fieldName] = value;
            
            // Trigger update to save the changes
            const updateEvent = new CustomEvent('stageCustomFieldUpdated', {
                detail: { stageId, fieldName, value }
            });
            document.dispatchEvent(updateEvent);
        }
    });
</script>

<style>
    .required:after {
        content: " *";
        color: red;
    }
    
    .stage-summary-card {
        transition: all 0.3s ease;
    }
    
    .stage-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .tab-pane {
        min-height: 400px;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .admin-override-section {
        border-left: 4px solid #ffc107;
        background-color: #fff3cd;
        padding: 1rem;
        border-radius: 0 0.375rem 0.375rem 0;
    }
</style>
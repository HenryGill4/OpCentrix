@model OpCentrix.Pages.Admin.PartsModel

<!-- Enhanced Parts Form with Working Bootstrap Tabs -->
<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-cogs me-2"></i>
        @(Model.Part.Id == 0 ? "Add New Part" : $"Edit Part: {Model.Part.PartNumber}")
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    @if (ViewData.ModelState.Any(ms => ms.Value?.Errors.Count > 0))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Please fix the following errors:</strong>
            <ul class="mb-0 mt-2">
                @foreach (var error in ViewData.ModelState.SelectMany(ms => ms.Value?.Errors ?? new Microsoft.AspNetCore.Mvc.ModelBinding.ModelErrorCollection()))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <form method="post" id="partForm" asp-page-handler="@(Model.Part.Id == 0 ? "Create" : "Update")" 
          hx-post="@("/Admin/Parts?handler=" + (Model.Part.Id == 0 ? "Create" : "Update"))"
          hx-target="#partModalContent"
          hx-indicator="#partSubmitSpinner">
        
        <input type="hidden" asp-for="Part.Id" />
        @if (Model.Part.Id > 0)
        {
            <input type="hidden" asp-for="Part.CreatedDate" />
            <input type="hidden" asp-for="Part.CreatedBy" />
        }
        
        <!-- Modern Tab Navigation -->
        <ul class="nav nav-tabs nav-justified mb-4" id="partFormTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" 
                        type="button" role="tab" aria-controls="basic" aria-selected="true">
                    <i class="fas fa-info-circle me-2"></i>
                    <span class="part-tab-text">Basic Information</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-tab" data-bs-toggle="tab" data-bs-target="#material" 
                        type="button" role="tab" aria-controls="material" aria-selected="false">
                    <i class="fas fa-flask me-2"></i>
                    <span class="part-tab-text">Material & Process</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manufacturing-tab" data-bs-toggle="tab" data-bs-target="#manufacturing" 
                        type="button" role="tab" aria-controls="manufacturing" aria-selected="false">
                    <i class="fas fa-industry me-2"></i>
                    <span class="part-tab-text">Manufacturing Stages</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="partFormTabsContent">
            
            <!-- TAB 1: Basic Information -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-info-circle me-2"></i>Essential Part Information
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.PartNumber" class="form-label part-required">Part Number</label>
                        <input asp-for="Part.PartNumber" class="form-control" required 
                               placeholder="e.g., PT-001-2024" />
                        <span asp-validation-for="Part.PartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-8">
                        <label asp-for="Part.Name" class="form-label part-required">Part Name</label>
                        <input asp-for="Part.Name" class="form-control" required 
                               placeholder="e.g., Titanium Bracket Assembly" />
                        <span asp-validation-for="Part.Name" class="text-danger"></span>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Part.Description" class="form-label part-required">Description</label>
                        <textarea asp-for="Part.Description" class="form-control" rows="3" required 
                                  placeholder="Detailed description of the part..."></textarea>
                        <span asp-validation-for="Part.Description" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.CustomerPartNumber" class="form-label">Customer Part Number</label>
                        <input asp-for="Part.CustomerPartNumber" class="form-control" 
                               placeholder="Customer's internal part number" />
                        <span asp-validation-for="Part.CustomerPartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Industry" class="form-label part-required">Industry</label>
                        <select asp-for="Part.Industry" class="form-select" required>
                            <option value="">Select Industry</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Defense">Defense</option>
                            <option value="Energy">Energy</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Medical">Medical</option>
                            <option value="Research">Research</option>
                        </select>
                        <span asp-validation-for="Part.Industry" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Application" class="form-label part-required">Application</label>
                        <select asp-for="Part.Application" class="form-select" required>
                            <option value="">Select Application</option>
                            <option value="General">General</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Production">Production</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Replacement">Replacement</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <span asp-validation-for="Part.Application" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartCategory" class="form-label">Category</label>
                        <select asp-for="Part.PartCategory" class="form-select">
                            <option value="Production">Production</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Repair">Repair</option>
                        </select>
                        <span asp-validation-for="Part.PartCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartClass" class="form-label">Part Class</label>
                        <select asp-for="Part.PartClass" class="form-select">
                            <option value="A">A - Critical (High Priority)</option>
                            <option value="B">B - Important (Medium Priority)</option>
                            <option value="C">C - Standard (Normal Priority)</option>
                        </select>
                        <span asp-validation-for="Part.PartClass" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-check mt-4 pt-2">
                            <input asp-for="Part.IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.IsActive" class="form-check-label">Active Part</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4 pt-2">
                            <input asp-for="Part.RequiresInspection" class="form-check-input" type="checkbox" 
                                   id="requiresInspectionBasic" />
                            <label asp-for="Part.RequiresInspection" class="form-check-label">Requires Inspection</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Material & Process -->
            <div class="tab-pane fade" id="material" role="tabpanel" aria-labelledby="material-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-flask me-2"></i>Material Selection & Process Parameters
                        </h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.Material" class="form-label part-required">Primary Material</label>
                        <select asp-for="Part.Material" class="form-select" id="materialSelect" required>
                            <option value="">Select Material</option>
                            <option value="Ti-6Al-4V Grade 5">Ti-6Al-4V Grade 5</option>
                            <option value="Ti-6Al-4V ELI Grade 23">Ti-6Al-4V ELI Grade 23</option>
                            <option value="Inconel 718">Inconel 718</option>
                            <option value="Inconel 625">Inconel 625</option>
                            <option value="316L Stainless Steel">316L Stainless Steel</option>
                            <option value="17-4 PH Stainless Steel">17-4 PH Stainless Steel</option>
                            <option value="AlSi10Mg">AlSi10Mg</option>
                        </select>
                        <span asp-validation-for="Part.Material" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ProcessType" class="form-label">Primary Process Type</label>
                        <select asp-for="Part.ProcessType" class="form-select">
                            <option value="SLS Metal">SLS Metal</option>
                            <option value="SLS Polymer">SLS Polymer</option>
                            <option value="DMLS">DMLS</option>
                            <option value="EBM">EBM</option>
                            <option value="CNC">CNC Machining</option>
                            <option value="EDM">EDM</option>
                        </select>
                        <span asp-validation-for="Part.ProcessType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.EstimatedHours" class="form-label part-required">Estimated Hours</label>
                        <input asp-for="Part.EstimatedHours" type="number" step="0.1" min="0.1" 
                               class="form-control" id="estimatedHoursInput" required />
                        <span asp-validation-for="Part.EstimatedHours" class="text-danger"></span>
                        <div class="form-text">Auto-filled based on material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.MaterialCostPerKg" class="form-label">Material Cost ($/kg)</label>
                        <input asp-for="Part.MaterialCostPerKg" type="number" step="0.01" 
                               class="form-control" id="materialCostInput" />
                        <span asp-validation-for="Part.MaterialCostPerKg" class="text-danger"></span>
                        <div class="form-text">Auto-filled based on material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.StandardLaborCostPerHour" class="form-label">Labor Cost ($/hour)</label>
                        <input asp-for="Part.StandardLaborCostPerHour" type="number" step="0.01" 
                               class="form-control" />
                        <span asp-validation-for="Part.StandardLaborCostPerHour" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Part.RequiredMachineType" class="form-label">Required Machine Type</label>
                        <input asp-for="Part.RequiredMachineType" class="form-control" 
                               placeholder="e.g., TruPrint 3000" />
                        <span asp-validation-for="Part.RequiredMachineType" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: Manufacturing Stages -->
            <div class="tab-pane fade" id="manufacturing" role="tabpanel" aria-labelledby="manufacturing-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-industry me-2"></i>Manufacturing Requirements & Stage Management
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Stage Management:</strong> Select required manufacturing stages and configure details. The system will calculate total time and complexity automatically.
                        </div>
                    </div>
                    
                    <!-- SLS Printing Stage -->
                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-primary text-white">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresSLSPrinting" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresSLSPrinting" data-stage="sls" />
                                    <label asp-for="Part.RequiresSLSPrinting" class="form-check-label fw-bold">
                                        <i class="fas fa-print me-2"></i>SLS Printing (Primary Manufacturing)
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="slsStageDetails">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label asp-for="Part.SetupTimeMinutes" class="form-label">Setup Time (minutes)</label>
                                        <input asp-for="Part.SetupTimeMinutes" type="number" step="1" min="0" 
                                               class="form-control" placeholder="e.g., 45" />
                                        <div class="form-text">Machine preparation</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label asp-for="Part.PostProcessingTimeMinutes" class="form-label">Post-Processing (minutes)</label>
                                        <input asp-for="Part.PostProcessingTimeMinutes" type="number" step="1" min="0" 
                                               class="form-control" placeholder="e.g., 120" />
                                        <div class="form-text">Cleaning, support removal</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check mt-4">
                                            <input asp-for="Part.RequiresSupports" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.RequiresSupports" class="form-check-label">Requires Support Structures</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CNC Machining Stage -->
                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-success text-white">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresCNCMachining" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresCNCMachining" data-stage="cnc" />
                                    <label asp-for="Part.RequiresCNCMachining" class="form-check-label fw-bold">
                                        <i class="fas fa-cogs me-2"></i>CNC Machining (Secondary Operations)
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="cncStageDetails">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    CNC machining provides precise dimensional control and surface finish improvements.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other stages following same pattern -->
                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-warning text-dark">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresEDMOperations" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresEDMOperations" data-stage="edm" />
                                    <label asp-for="Part.RequiresEDMOperations" class="form-check-label fw-bold">
                                        <i class="fas fa-bolt me-2"></i>EDM Operations
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="edmStageDetails">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    EDM operations for complex internal geometries.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-info text-white">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresAssembly" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresAssembly" data-stage="assembly" />
                                    <label asp-for="Part.RequiresAssembly" class="form-check-label fw-bold">
                                        <i class="fas fa-puzzle-piece me-2"></i>Assembly Operations
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="assemblyStageDetails">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input asp-for="Part.IsAssemblyComponent" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.IsAssemblyComponent" class="form-check-label">Is Assembly Component</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input asp-for="Part.IsSubAssembly" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.IsSubAssembly" class="form-check-label">Is Sub-Assembly</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-secondary text-white">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresFinishing" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresFinishing" data-stage="finishing" />
                                    <label asp-for="Part.RequiresFinishing" class="form-check-label fw-bold">
                                        <i class="fas fa-brush me-2"></i>Finishing Operations
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="finishingStageDetails">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label asp-for="Part.SurfaceFinishRequirement" class="form-label">Surface Finish Type</label>
                                        <select asp-for="Part.SurfaceFinishRequirement" class="form-select">
                                            <option value="As-built">As-built</option>
                                            <option value="Machined">Machined</option>
                                            <option value="Polished">Polished</option>
                                            <option value="Sandblasted">Sandblasted</option>
                                            <option value="Coated">Coated</option>
                                            <option value="Anodized">Anodized</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="Part.MaxSurfaceRoughnessRa" class="form-label">Max Surface Roughness Ra (µm)</label>
                                        <input asp-for="Part.MaxSurfaceRoughnessRa" type="number" step="0.1" class="form-control" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="part-stage-card">
                            <div class="part-stage-header bg-danger text-white">
                                <div class="form-check mb-0">
                                    <input asp-for="Part.RequiresInspection" class="form-check-input part-stage-checkbox" type="checkbox" 
                                           id="requiresInspection" data-stage="inspection" />
                                    <label asp-for="Part.RequiresInspection" class="form-check-label fw-bold">
                                        <i class="fas fa-search me-2"></i>Quality Inspection
                                    </label>
                                </div>
                            </div>
                            <div class="part-stage-details" id="inspectionStageDetails">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input asp-for="Part.RequiresFDA" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.RequiresFDA" class="form-check-label">FDA Compliance</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input asp-for="Part.RequiresAS9100" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.RequiresAS9100" class="form-check-label">AS9100 Certification</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input asp-for="Part.RequiresNADCAP" class="form-check-input" type="checkbox" />
                                            <label asp-for="Part.RequiresNADCAP" class="form-check-label">NADCAP Certification</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manufacturing Summary -->
                    <div class="col-12">
                        <div class="part-summary-card">
                            <div class="part-summary-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Manufacturing Summary
                                </h6>
                            </div>
                            <div class="part-summary-content" id="manufacturingSummaryContent">
                                <p class="text-muted">Select stages above to see manufacturing complexity analysis.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Override Section -->
                    <div class="col-12 mt-4">
                        <div class="part-admin-override-card">
                            <div class="part-admin-override-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-shield me-2"></i>Administrative Override (Optional)
                                </h6>
                            </div>
                            <div class="part-admin-override-content">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label asp-for="Part.AdminEstimatedHoursOverride" class="form-label">Duration Override (hours)</label>
                                        <input asp-for="Part.AdminEstimatedHoursOverride" type="number" step="0.1" min="0.1" 
                                               id="adminOverrideInput" class="form-control" />
                                        <span asp-validation-for="Part.AdminEstimatedHoursOverride" class="text-danger"></span>
                                        <div class="form-text">Leave blank to use standard estimate</div>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <label asp-for="Part.AdminOverrideReason" class="form-label">Override Justification</label>
                                        <textarea asp-for="Part.AdminOverrideReason" class="form-control" rows="2" 
                                                  id="overrideReasonText"
                                                  placeholder="Required when using override values..."></textarea>
                                        <span asp-validation-for="Part.AdminOverrideReason" class="text-danger"></span>
                                        <div class="form-text part-override-required-text" id="overrideRequiredText">
                                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                            <strong>Override reason is required when duration override is set.</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Cancel
    </button>
    <button type="submit" form="partForm" class="btn btn-primary" id="savePartBtn">
        <i class="fas fa-save me-1"></i>
        <span class="btn-text">@(Model.Part.Id == 0 ? "Create Part" : "Update Part")</span>
        <span id="partSubmitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
</div>

<script>
// Material defaults configuration
const MATERIAL_DEFAULTS = {
    'Ti-6Al-4V Grade 5': { estimatedHours: 8.0, materialCostPerKg: 450.00 },
    'Ti-6Al-4V ELI Grade 23': { estimatedHours: 9.0, materialCostPerKg: 520.00 },
    'Inconel 718': { estimatedHours: 12.0, materialCostPerKg: 750.00 },
    'Inconel 625': { estimatedHours: 14.0, materialCostPerKg: 850.00 },
    '316L Stainless Steel': { estimatedHours: 6.0, materialCostPerKg: 280.00 },
    '17-4 PH Stainless Steel': { estimatedHours: 7.0, materialCostPerKg: 320.00 },
    'AlSi10Mg': { estimatedHours: 5.0, materialCostPerKg: 180.00 }
};

// Modern Parts Form Handler
class PartsFormHandler {
    constructor() {
        this.init();
    }

    init() {
        console.log('🔧 [PARTS] Initializing modern parts form handler...');
        
        this.setupFormSubmission();
        this.setupMaterialDefaults();
        this.setupStageManagement();
        this.setupAdminOverride();
        this.setupBootstrapTabs();
        
        console.log('✅ [PARTS] Parts form handler initialized successfully');
    }

    setupFormSubmission() {
        const form = document.getElementById('partForm');
        const submitBtn = document.getElementById('savePartBtn');
        
        if (form && submitBtn) {
            form.addEventListener('submit', (e) => {
                const spinner = document.getElementById('partSubmitSpinner');
                if (spinner) {
                    spinner.classList.remove('d-none');
                    submitBtn.disabled = true;
                }
            });
            
            document.addEventListener('htmx:responseError', () => this.resetSubmitButton());
            document.addEventListener('htmx:afterRequest', (evt) => {
                if (evt.detail.xhr.status !== 200) {
                    this.resetSubmitButton();
                }
            });
        }
    }

    resetSubmitButton() {
        const submitBtn = document.getElementById('savePartBtn');
        const spinner = document.getElementById('partSubmitSpinner');
        
        if (submitBtn && spinner) {
            spinner.classList.add('d-none');
            submitBtn.disabled = false;
        }
    }

    setupMaterialDefaults() {
        const materialSelect = document.getElementById('materialSelect');
        
        if (materialSelect) {
            materialSelect.addEventListener('change', (e) => {
                this.updateMaterialDefaults(e.target.value);
            });
        }
    }

    updateMaterialDefaults(selectedMaterial) {
        console.log('🧪 [PARTS] Updating material defaults for:', selectedMaterial);
        
        const estimatedHoursInput = document.getElementById('estimatedHoursInput');
        const materialCostInput = document.getElementById('materialCostInput');
        
        if (!estimatedHoursInput || !materialCostInput) {
            console.warn('⚠️ [PARTS] Material inputs not found');
            return;
        }
        
        const defaults = MATERIAL_DEFAULTS[selectedMaterial];
        
        if (defaults) {
            if (!estimatedHoursInput.value || parseFloat(estimatedHoursInput.value) <= 1) {
                estimatedHoursInput.value = defaults.estimatedHours;
            }
            
            if (!materialCostInput.value || parseFloat(materialCostInput.value) <= 1) {
                materialCostInput.value = defaults.materialCostPerKg;
            }
            
            console.log(`✅ [PARTS] Material defaults applied for: ${selectedMaterial}`);
            this.updateManufacturingSummary();
        }
    }

    setupStageManagement() {
        const stageCheckboxes = document.querySelectorAll('.part-stage-checkbox');
        
        stageCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                this.toggleStageDetails(e.target.dataset.stage, e.target.checked);
                this.updateManufacturingSummary();
            });
            
            this.toggleStageDetails(checkbox.dataset.stage, checkbox.checked);
        });
    }

    toggleStageDetails(stageName, isEnabled) {
        const detailsElement = document.getElementById(`${stageName}StageDetails`);
        
        if (detailsElement) {
            if (isEnabled) {
                detailsElement.style.display = 'block';
                detailsElement.classList.add('show');
            } else {
                detailsElement.style.display = 'none';
                detailsElement.classList.remove('show');
            }
        }
    }

    updateManufacturingSummary() {
        const summaryElement = document.getElementById('manufacturingSummaryContent');
        if (!summaryElement) return;
        
        const stages = [];
        let totalStages = 0;
        
        const stageChecks = [
            { name: 'SLS Printing', checkbox: 'requiresSLSPrinting', icon: 'fas fa-print', class: 'bg-primary' },
            { name: 'CNC Machining', checkbox: 'requiresCNCMachining', icon: 'fas fa-cogs', class: 'bg-success' },
            { name: 'EDM Operations', checkbox: 'requiresEDMOperations', icon: 'fas fa-bolt', class: 'bg-warning text-dark' },
            { name: 'Assembly', checkbox: 'requiresAssembly', icon: 'fas fa-puzzle-piece', class: 'bg-info' },
            { name: 'Finishing', checkbox: 'requiresFinishing', icon: 'fas fa-brush', class: 'bg-secondary' },
            { name: 'Inspection', checkbox: 'requiresInspection', icon: 'fas fa-search', class: 'bg-danger' }
        ];
        
        stageChecks.forEach(stage => {
            const checkbox = document.getElementById(stage.checkbox);
            if (checkbox && checkbox.checked) {
                totalStages++;
                stages.push(`<span class="badge ${stage.class} me-1"><i class="${stage.icon} me-1"></i>${stage.name}</span>`);
            }
        });
        
        const estimatedHours = parseFloat(document.getElementById('estimatedHoursInput')?.value || 0);
        
        if (stages.length > 0 || estimatedHours > 0) {
            const complexity = totalStages >= 4 ? 'Very Complex' : 
                             totalStages >= 3 ? 'Complex' : 
                             totalStages >= 2 ? 'Medium' : 'Simple';
            
            const complexityClass = complexity === 'Very Complex' ? 'bg-danger' :
                                  complexity === 'Complex' ? 'bg-warning text-dark' :
                                  complexity === 'Medium' ? 'bg-info' : 'bg-success';
            
            summaryElement.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <strong>Manufacturing Workflow (${totalStages} stage${totalStages !== 1 ? 's' : ''}):</strong><br>
                        <div class="mt-2">${stages.length > 0 ? stages.join(' ') : '<span class="text-muted">Primary process only</span>'}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <div class="h5 text-primary mb-1">${estimatedHours.toFixed(1)} hours</div>
                            <span class="badge ${complexityClass}">${complexity}</span><br>
                            <small class="text-muted">Base Manufacturing Time</small>
                        </div>
                    </div>
                </div>
            `;
        } else {
            summaryElement.innerHTML = '<p class="text-muted">Select stages above to see manufacturing complexity analysis.</p>';
        }
    }

    setupAdminOverride() {
        const overrideInput = document.getElementById('adminOverrideInput');
        const reasonTextarea = document.getElementById('overrideReasonText');
        const requiredText = document.getElementById('overrideRequiredText');
        
        if (overrideInput && reasonTextarea && requiredText) {
            overrideInput.addEventListener('input', () => {
                const hasOverride = parseFloat(overrideInput.value) > 0;
                
                reasonTextarea.required = hasOverride;
                requiredText.style.display = hasOverride ? 'block' : 'none';
                
                if (hasOverride) {
                    reasonTextarea.classList.add('border-warning');
                } else {
                    reasonTextarea.classList.remove('border-warning');
                    reasonTextarea.value = '';
                }
            });
        }
    }

    setupBootstrapTabs() {
        const tabTriggerList = document.querySelectorAll('#partFormTabs button[data-bs-toggle="tab"]');
        tabTriggerList.forEach(tabTriggerEl => {
            tabTriggerEl.addEventListener('shown.bs.tab', (event) => {
                console.log('🔄 [PARTS] Tab switched to:', event.target.getAttribute('aria-controls'));
            });
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        new PartsFormHandler();
    }, 100);
});

console.log('✅ [PARTS] Modern parts form script loaded successfully');
</script>

<link rel="stylesheet" href="~/css/parts-form.css" />
@model OpCentrix.Pages.Admin.PartsModel

<!-- Enhanced Parts Form with Working Bootstrap Tabs -->
<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="fas fa-cogs me-2"></i>
        @(Model.Part.Id == 0 ? "Add New Part" : $"Edit Part: {Model.Part.PartNumber}")
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    @if (ViewData.ModelState.Any(ms => ms.Value?.Errors.Count > 0))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Please fix the following errors:</strong>
            <ul class="mb-0 mt-2">
                @foreach (var error in ViewData.ModelState.SelectMany(ms => ms.Value?.Errors ?? new Microsoft.AspNetCore.Mvc.ModelBinding.ModelErrorCollection()))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- FIXED: Clean HTMX-only form submission -->
    <form id="partForm" 
          hx-post="@("/Admin/Parts?handler=" + (Model.Part.Id == 0 ? "Create" : "Update"))"
          hx-target="#partModalContent"
          hx-swap="innerHTML"
          hx-indicator="#partSubmitSpinner"
          hx-on::after-request="handlePartFormResponse(event)">
        
        <input type="hidden" asp-for="Part.Id" />
        @if (Model.Part.Id > 0)
        {
            <input type="hidden" asp-for="Part.CreatedDate" />
            <input type="hidden" asp-for="Part.CreatedBy" />
        }
        
        <!-- Modern Tab Navigation -->
        <ul class="nav nav-tabs nav-justified mb-4" id="partFormTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" 
                        type="button" role="tab" aria-controls="basic" aria-selected="true">
                    <i class="fas fa-info-circle me-2"></i>
                    <span class="part-tab-text">Basic Information</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-tab" data-bs-toggle="tab" data-bs-target="#material" 
                        type="button" role="tab" aria-controls="material" aria-selected="false">
                    <i class="fas fa-flask me-2"></i>
                    <span class="part-tab-text">Material & Process</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manufacturing-tab" data-bs-toggle="tab" data-bs-target="#manufacturing" 
                        type="button" role="tab" aria-controls="manufacturing" aria-selected="false">
                    <i class="fas fa-industry me-2"></i>
                    <span class="part-tab-text">Manufacturing Stages</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="partFormTabsContent">
            
            <!-- TAB 1: Basic Information -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-info-circle me-2"></i>Essential Part Information
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.PartNumber" class="form-label part-required">Part Number</label>
                        <input asp-for="Part.PartNumber" class="form-control" required 
                               placeholder="e.g., PT-001-2024" />
                        <span asp-validation-for="Part.PartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-8">
                        <label asp-for="Part.Name" class="form-label part-required">Part Name</label>
                        <input asp-for="Part.Name" class="form-control" required 
                               placeholder="e.g., Titanium Bracket Assembly" />
                        <span asp-validation-for="Part.Name" class="text-danger"></span>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Part.Description" class="form-label part-required">Description</label>
                        <textarea asp-for="Part.Description" class="form-control" rows="3" required 
                                  placeholder="Detailed description of the part..."></textarea>
                        <span asp-validation-for="Part.Description" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.CustomerPartNumber" class="form-label">Customer Part Number</label>
                        <input asp-for="Part.CustomerPartNumber" class="form-control" 
                               placeholder="Customer's internal part number" />
                        <span asp-validation-for="Part.CustomerPartNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Industry" class="form-label part-required">Industry</label>
                        <select asp-for="Part.Industry" class="form-select" required>
                            <option value="">Select Industry</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Defense">Defense</option>
                            <option value="Energy">Energy</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Medical">Medical</option>
                            <option value="Research">Research</option>
                        </select>
                        <span asp-validation-for="Part.Industry" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Part.Application" class="form-label part-required">Application</label>
                        <select asp-for="Part.Application" class="form-select" required>
                            <option value="">Select Application</option>
                            <option value="General">General</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Production">Production</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Replacement">Replacement</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <span asp-validation-for="Part.Application" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartCategory" class="form-label">Category</label>
                        <select asp-for="Part.PartCategory" class="form-select">
                            <option value="Production">Production</option>
                            <option value="Prototype">Prototype</option>
                            <option value="Tooling">Tooling</option>
                            <option value="Repair">Repair</option>
                        </select>
                        <span asp-validation-for="Part.PartCategory" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <label asp-for="Part.PartClass" class="form-label">Part Class</label>
                        <select asp-for="Part.PartClass" class="form-select">
                            <option value="A">A - Critical (High Priority)</option>
                            <option value="B">B - Important (Medium Priority)</option>
                            <option value="C">C - Standard (Normal Priority)</option>
                        </select>
                        <span asp-validation-for="Part.PartClass" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-check mt-4 pt-2">
                            <input asp-for="Part.IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.IsActive" class="form-check-label">Active Part</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4 pt-2">
                            <input asp-for="Part.RequiresInspection" class="form-check-input" type="checkbox" 
                                   id="requiresInspectionBasic" />
                            <label asp-for="Part.RequiresInspection" class="form-check-label">Requires Inspection</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Material & Process -->
            <div class="tab-pane fade" id="material" role="tabpanel" aria-labelledby="material-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-flask me-2"></i>Material Selection & Process Parameters
                        </h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.Material" class="form-label part-required">Primary Material</label>
                        <select asp-for="Part.Material" class="form-select" id="materialSelect" required>
                            <option value="">Select Material</option>
                            <option value="Ti-6Al-4V Grade 5">Ti-6Al-4V Grade 5</option>
                            <option value="Ti-6Al-4V ELI Grade 23">Ti-6Al-4V ELI Grade 23</option>
                            <option value="Inconel 718">Inconel 718</option>
                            <option value="Inconel 625">Inconel 625</option>
                            <option value="316L Stainless Steel">316L Stainless Steel</option>
                            <option value="17-4 PH Stainless Steel">17-4 PH Stainless Steel</option>
                            <option value="AlSi10Mg">AlSi10Mg</option>
                        </select>
                        <span asp-validation-for="Part.Material" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.ProcessType" class="form-label">Primary Process Type</label>
                        <select asp-for="Part.ProcessType" class="form-select">
                            <option value="SLS Metal">SLS Metal</option>
                            <option value="SLS Polymer">SLS Polymer</option>
                            <option value="DMLS">DMLS</option>
                            <option value="EBM">EBM</option>
                            <option value="CNC">CNC Machining</option>
                            <option value="EDM">EDM</option>
                        </select>
                        <span asp-validation-for="Part.ProcessType" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.EstimatedHours" class="form-label part-required">Estimated Hours</label>
                        <input asp-for="Part.EstimatedHours" type="number" step="0.1" min="0.1" 
                               class="form-control" id="estimatedHoursInput" required />
                        <span asp-validation-for="Part.EstimatedHours" class="text-danger"></span>
                        <div class="form-text">Auto-filled based on material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.MaterialCostPerKg" class="form-label">Material Cost ($/kg)</label>
                        <input asp-for="Part.MaterialCostPerKg" type="number" step="0.01" 
                               class="form-control" id="materialCostInput" />
                        <span asp-validation-for="Part.MaterialCostPerKg" class="text-danger"></span>
                        <div class="form-text">Auto-filled based on material selection</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Part.StandardLaborCostPerHour" class="form-label">Labor Cost ($/hour)</label>
                        <input asp-for="Part.StandardLaborCostPerHour" type="number" step="0.01" 
                               class="form-control" />
                        <span asp-validation-for="Part.StandardLaborCostPerHour" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Part.RequiredMachineType" class="form-label">Required Machine Type</label>
                        <input asp-for="Part.RequiredMachineType" class="form-control" 
                               placeholder="e.g., TruPrint 3000" />
                        <span asp-validation-for="Part.RequiredMachineType" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: Manufacturing Stages (simplified for now) -->
            <div class="tab-pane fade" id="manufacturing" role="tabpanel" aria-labelledby="manufacturing-tab">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="part-section-header">
                            <i class="fas fa-industry me-2"></i>Manufacturing Requirements
                        </h6>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresSLSPrinting" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresSLSPrinting" class="form-check-label">Requires SLS Printing</label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresCNCMachining" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresCNCMachining" class="form-check-label">Requires CNC Machining</label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresFinishing" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresFinishing" class="form-check-label">Requires Finishing</label>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresInspection" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresInspection" class="form-check-label">Requires Inspection</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresFDA" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresFDA" class="form-check-label">FDA Compliance Required</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="Part.RequiresAS9100" class="form-check-input" type="checkbox" />
                            <label asp-for="Part.RequiresAS9100" class="form-check-label">AS9100 Certification</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>Cancel
    </button>
    <button type="submit" form="partForm" class="btn btn-primary" id="savePartBtn">
        <i class="fas fa-save me-1"></i>
        <span class="btn-text">@(Model.Part.Id == 0 ? "Create Part" : "Update Part")</span>
        <span id="partSubmitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
</div>

<script>
console.log('🔧 [PARTS] Loading enhanced parts form with fixed submission...' );

// Material defaults configuration
const MATERIAL_DEFAULTS = {
    'Ti-6Al-4V Grade 5': { estimatedHours: 8.0, materialCostPerKg: 450.00 },
    'Ti-6Al-4V ELI Grade 23': { estimatedHours: 9.0, materialCostPerKg: 520.00 },
    'Inconel 718': { estimatedHours: 12.0, materialCostPerKg: 750.00 },
    'Inconel 625': { estimatedHours: 14.0, materialCostPerKg: 850.00 },
    '316L Stainless Steel': { estimatedHours: 6.0, materialCostPerKg: 280.00 },
    '17-4 PH Stainless Steel': { estimatedHours: 7.0, materialCostPerKg: 320.00 },
    'AlSi10Mg': { estimatedHours: 5.0, materialCostPerKg: 180.00 }
};

// FIXED: Enhanced HTMX response handler
window.handlePartFormResponse = function(event) {
    console.log('📋 [PARTS] Form response received:', event.detail.xhr.status);
    
    try {
        const xhr = event.detail.xhr;
        const response = xhr.responseText;
        
        // Reset submit button state
        const submitBtn = document.getElementById('savePartBtn');
        const spinner = document.getElementById('partSubmitSpinner');
        
        if (submitBtn && spinner) {
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
        }
        
        // Check for success (2xx status codes)
        if (xhr.status >= 200 && xhr.status < 300) {
            
            // Check if response contains JavaScript (success response)
            if (response.includes('<script>') || response.includes('window.location.reload')) {
                console.log('✅ [PARTS] Success response received');
                
                // Execute the JavaScript response (contains modal close + reload)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = response;
                const scripts = tempDiv.querySelectorAll('script');
                
                scripts.forEach(script => {
                    try {
                        eval(script.textContent);
                        console.log('✅ [PARTS] Success script executed');
                    } catch (error) {
                        console.error('❌ [PARTS] Error executing success script:', error);
                    }
                });
                return;
            }
            
            // Check for validation errors (form with errors)
            if (response.includes('ValidationErrors') || response.includes('alert-danger')) {
                console.log('⚠️ [PARTS] Validation errors in response');
                // Response contains the form with validation errors - HTMX will display it
                return;
            }
            
            // Unexpected success response
            console.log('✅ [PARTS] Unexpected success response, closing modal');
            closePartModal();
            showPartToast('success', 'Part saved successfully');
            setTimeout(() => window.location.reload(), 1000);
            
        } else {
            // Error response
            console.error('❌ [PARTS] Server error:', xhr.status, xhr.statusText);
            showPartToast('error', `Server error: ${xhr.status} ${xhr.statusText}`);
        }
        
    } catch (error) {
        console.error('❌ [PARTS] Error handling form response:', error);
        showPartToast('error', 'Unexpected error processing response');
    }
};

// FIXED: Robust modal close functionality
function closePartModal() {
    console.log('❌ [PARTS] Closing part modal');
    
    try {
        const modal = document.getElementById('partModal');
        if (modal) {
            // Try Bootstrap modal instance first
            if (typeof bootstrap !== 'undefined') {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                    console.log('✅ [PARTS] Modal closed via Bootstrap instance');
                    return;
                }
            }
            
            // Fallback modal close
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            
            // Remove backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            
            console.log('✅ [PARTS] Modal closed via fallback method');
        }
    } catch (error) {
        console.error('❌ [PARTS] Error closing modal:', error);
    }
}

// FIXED: Enhanced toast notifications
function showPartToast(type, message) {
    console.log(`📢 [PARTS] Showing ${type} toast:`, message);
    
    try {
        // Try using existing global toast function first
        if (typeof window.showToast === 'function') {
            window.showToast(type, message);
            return;
        }
        
        // Fallback to Bootstrap toast
        if (typeof bootstrap !== 'undefined') {
            const toastId = 'part-toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" 
                     role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
            
        } else {
            // Ultimate fallback
            alert(`${type.toUpperCase()}: ${message}`);
        }
        
    } catch (error) {
        console.error('❌ [PARTS] Error showing toast:', error);
        alert(`${type.toUpperCase()}: ${message}`);
    }
}

// Material defaults handler
function updateMaterialDefaults(selectedMaterial) {
    console.log('🧪 [PARTS] Updating material defaults for:', selectedMaterial);
    
    const estimatedHoursInput = document.getElementById('estimatedHoursInput');
    const materialCostInput = document.getElementById('materialCostInput');
    
    if (!estimatedHoursInput || !materialCostInput) {
        console.warn('⚠️ [PARTS] Material inputs not found');
        return;
    }
    
    const defaults = MATERIAL_DEFAULTS[selectedMaterial];
    
    if (defaults) {
        if (!estimatedHoursInput.value || parseFloat(estimatedHoursInput.value) <= 1) {
            estimatedHoursInput.value = defaults.estimatedHours;
        }
        
        if (!materialCostInput.value || parseFloat(materialCostInput.value) <= 1) {
            materialCostInput.value = defaults.materialCostPerKg;
        }
        
        console.log(`✅ [PARTS] Material defaults applied for: ${selectedMaterial}`);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 [PARTS] Initializing parts form...');
    
    try {
        // Setup material selection handler
        const materialSelect = document.getElementById('materialSelect');
        if (materialSelect) {
            materialSelect.addEventListener('change', (e) => {
                updateMaterialDefaults(e.target.value);
            });
        }
        
        // Setup form submit button management
        const form = document.getElementById('partForm');
        const submitBtn = document.getElementById('savePartBtn');
        const spinner = document.getElementById('partSubmitSpinner');
        
        if (form && submitBtn && spinner) {
            form.addEventListener('submit', () => {
                submitBtn.disabled = true;
                spinner.classList.remove('d-none');
                console.log('📤 [PARTS] Form submitted, showing loading state');
            });
        }
        
        console.log('✅ [PARTS] Parts form initialized successfully');
        
    } catch (error) {
        console.error('❌ [PARTS] Error initializing parts form:', error);
    }
});

// Expose functions globally for HTML event handlers
window.closePartModal = closePartModal;
window.showPartToast = showPartToast;
window.updateMaterialDefaults = updateMaterialDefaults;

console.log('✅ [PARTS] Enhanced parts form script loaded successfully');
</script>

<style>
    .part-section-header {
        color: #495057;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
        margin-bottom: 16px;
    }

    .part-required::after {
        content: " *";
        color: #dc3545;
    }

    .part-tab-text {
        font-size: 0.9rem;
        font-weight: 500;
    }

    @@media (max-width: 768px) {
        .part-tab-text {
            display: none;
        }
    }
</style>
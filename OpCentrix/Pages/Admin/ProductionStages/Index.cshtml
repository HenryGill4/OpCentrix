@page
@model OpCentrix.Pages.Admin.ProductionStages.IndexModel
@{
    ViewData["Title"] = "Production Stage Configuration";
    ViewData["PageHeader"] = "?? Production Stage Configuration";
    ViewData["PageDescription"] = "Configure and manage manufacturing stages with custom fields and machine assignments";
}

<div class="container-fluid">
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-cogs me-2"></i>
                        Production Stage Configuration
                    </h2>
                    <p class="text-muted mb-0">Configure manufacturing stages with custom fields and machine assignments</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#reorderModal">
                        <i class="fas fa-sort me-1"></i>
                        Reorder Stages
                    </button>
                    <button class="btn btn-secondary me-2" onclick="createDefaultStages()">
                        <i class="fas fa-download me-1"></i>
                        Import Defaults
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStageModal">
                        <i class="fas fa-plus me-1"></i>
                        Add New Stage
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Stages Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2 text-primary"></i>
                        Production Stages (@Model.ProductionStages.Count stages configured)
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.ProductionStages.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="80">Order</th>
                                        <th>Stage Info</th>
                                        <th>Timing & Cost</th>
                                        <th>Machine Assignment</th>
                                        <th>Custom Fields</th>
                                        <th width="100">Usage</th>
                                        <th width="150">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stage in Model.ProductionStages.OrderBy(s => s.DisplayOrder))
                                    {
                                        var stats = Model.StageUsageStatistics.GetValueOrDefault(stage.Id, new StageUsageStats());
                                        var customFields = stage.GetCustomFields();
                                        var assignedMachines = stage.GetAssignedMachineIds();
                                        
                                        <tr>
                                            <td>
                                                <span class="badge fs-6" style="background-color: @stage.StageColor;">@stage.DisplayOrder</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="@stage.StageIcon me-2" style="color: @stage.StageColor;"></i>
                                                    <div>
                                                        <strong>@stage.Name</strong>
                                                        @if (!string.IsNullOrEmpty(stage.Department))
                                                        {
                                                            <span class="badge bg-info ms-2">@stage.Department</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(stage.Description))
                                                        {
                                                            <div class="small text-muted">@stage.Description</div>
                                                        }
                                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                                            @if (stage.IsOptional)
                                                            {
                                                                <span class="badge bg-info">Optional</span>
                                                            }
                                                            @if (stage.AllowSkip)
                                                            {
                                                                <span class="badge bg-warning">Skippable</span>
                                                            }
                                                            @if (stage.RequiresApproval)
                                                            {
                                                                <span class="badge bg-danger">Requires Approval</span>
                                                            }
                                                            @if (stage.AllowParallelExecution)
                                                            {
                                                                <span class="badge bg-success">Parallel OK</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong class="text-info">@stage.DefaultDurationHours.ToString("F1")h</strong>
                                                    <span class="text-muted">@(Html.Raw("$")) $@stage.DefaultHourlyRate.ToString("F2")/hr</span>
                                                </div>
                                                <div class="small text-muted">
                                                    Setup: @stage.DefaultSetupMinutes min
                                                </div>
                                                @if (stage.DefaultMaterialCost > 0)
                                                {
                                                    <div class="small text-success">
                                                        Materials: $@stage.DefaultMaterialCost.ToString("F2")
                                                    </div>
                                                }
                                                <div class="small fw-bold text-primary">
                                                    Total: $@stage.GetTotalEstimatedCost().ToString("F2")
                                                </div>
                                            </td>
                                            <td>
                                                @if (stage.RequiresMachineAssignment)
                                                {
                                                    <div class="mb-1">
                                                        <span class="badge bg-warning text-dark">Machine Required</span>
                                                    </div>
                                                    @if (assignedMachines.Any())
                                                    {
                                                        <div class="small">
                                                            <strong>Assigned:</strong>
                                                            @foreach (var machineId in assignedMachines)
                                                            {
                                                                <span class="badge bg-secondary me-1">@machineId</span>
                                                            }
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(stage.DefaultMachineId))
                                                    {
                                                        <div class="small text-primary">
                                                            Default: @stage.DefaultMachineId
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">Any Machine</span>
                                                }
                                            </td>
                                            <td>
                                                @if (customFields.Any())
                                                {
                                                    <div class="badge bg-primary">@customFields.Count field@(customFields.Count == 1 ? "" : "s")</div>
                                                    <div class="small mt-1">
                                                        @foreach (var field in customFields.Take(3))
                                                        {
                                                            <div class="text-muted">
                                                                <i class="fas fa-@(field.Type switch { "number" => "hashtag", "dropdown" => "list", "checkbox" => "check-square", "date" => "calendar", _ => "text-width" }) me-1"></i>
                                                                @field.Label
                                                            </div>
                                                        }
                                                        @if (customFields.Count > 3)
                                                        {
                                                            <div class="text-muted">... and @(customFields.Count - 3) more</div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">No custom fields</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column small">
                                                    <div>
                                                        <i class="fas fa-cube text-primary me-1" title="Parts using this stage"></i>
                                                        @stats.PartUsageCount
                                                    </div>
                                                    <div>
                                                        <i class="fas fa-flask text-success me-1" title="Prototype executions"></i>
                                                        @stats.PrototypeUsageCount
                                                    </div>
                                                    @if (stats.CompletedExecutions > 0)
                                                    {
                                                        <div class="text-info">
                                                            <i class="fas fa-clock me-1"></i>
                                                            @stats.AverageActualHours.ToString("F1")h avg
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" 
                                                            onclick="editStage(@stage.Id)" 
                                                            title="Edit Stage">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-info" 
                                                            onclick="manageCustomFields(@stage.Id)" 
                                                            title="Manage Custom Fields">
                                                        <i class="fas fa-wrench"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger @(stats.TotalUsageCount > 0 ? "disabled" : "")" 
                                                            onclick="@(stats.TotalUsageCount > 0 ? "void(0)" : $"deleteStage({stage.Id}, '{stage.Name}')")" 
                                                            title="@(stats.TotalUsageCount > 0 ? $"Cannot delete - used by {stats.TotalUsageCount} items" : "Delete Stage")">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Usage Summary -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="mb-2">
                                <i class="fas fa-chart-bar me-2"></i>
                                Usage Summary
                            </h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-primary">@Model.ProductionStages.Count</div>
                                        <div class="small text-muted">Total Stages</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-success">@Model.StageUsageStatistics.Values.Sum(s => s.PartUsageCount)</div>
                                        <div class="small text-muted">Part Assignments</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-info">@Model.StageUsageStatistics.Values.Sum(s => s.PrototypeUsageCount)</div>
                                        <div class="small text-muted">Prototype Executions</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-warning">@Model.StageUsageStatistics.Values.Sum(s => s.CompletedExecutions)</div>
                                        <div class="small text-muted">Completed Jobs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-cogs fa-3x mb-3"></i>
                            <h5>No Production Stages Configured</h5>
                            <p>Configure production stages to enable enhanced parts workflow management.</p>
                            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addStageModal">
                                <i class="fas fa-plus me-1"></i>
                                Add First Stage
                            </button>
                            <button class="btn btn-secondary" onclick="createDefaultStages()">
                                <i class="fas fa-download me-1"></i>
                                Import Default Stages
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Add New Stage Modal -->
<div class="modal fade" id="addStageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateStage" id="addStageForm">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Add New Production Stage
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Enhanced tabbed interface for stage configuration -->
                    <ul class="nav nav-tabs mb-3" id="stageConfigTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-config-tab" data-bs-toggle="tab" data-bs-target="#basic-config" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timing-config-tab" data-bs-toggle="tab" data-bs-target="#timing-config" type="button" role="tab">
                                <i class="fas fa-clock me-1"></i>Timing & Cost
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="machine-config-tab" data-bs-toggle="tab" data-bs-target="#machine-config" type="button" role="tab">
                                <i class="fas fa-cogs me-1"></i>Machine Assignment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fields-config-tab" data-bs-toggle="tab" data-bs-target="#fields-config" type="button" role="tab">
                                <i class="fas fa-wrench me-1"></i>Custom Fields
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="stageConfigTabsContent">
                        <!-- Basic Info Tab -->
                        <div class="tab-pane fade show active" id="basic-config" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label asp-for="NewStage.Name" class="form-label">Stage Name *</label>
                                        <input asp-for="NewStage.Name" class="form-control" placeholder="e.g., CNC Machining" required maxlength="100">
                                        <span asp-validation-for="NewStage.Name" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label asp-for="NewStage.RequiredRole" class="form-label">Required Role</label>
                                        <select asp-for="NewStage.RequiredRole" class="form-select">
                                            <option value="">Any Role</option>
                                            <option value="Operator">Operator</option>
                                            <option value="Machinist">Machinist</option>
                                            <option value="EDM Specialist">EDM Specialist</option>
                                            <option value="Finisher">Finisher</option>
                                            <option value="Coater">Coater</option>
                                            <option value="Assembler">Assembler</option>
                                            <option value="Quality Inspector">Quality Inspector</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label asp-for="NewStage.Description" class="form-label">Description</label>
                                <textarea asp-for="NewStage.Description" class="form-control" rows="2" placeholder="Brief description of this manufacturing stage" maxlength="500"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <select name="NewStage.Department" class="form-select">
                                            <option value="">Select Department</option>
                                            <option value="3D Printing">3D Printing</option>
                                            <option value="CNC Machining">CNC Machining</option>
                                            <option value="EDM">EDM</option>
                                            <option value="Finishing">Finishing</option>
                                            <option value="Coating">Coating</option>
                                            <option value="Assembly">Assembly</option>
                                            <option value="Quality Control">Quality Control</option>
                                            <option value="Shipping">Shipping</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Stage Color</label>
                                        <input type="color" name="NewStage.StageColor" class="form-control form-control-color" value="#007bff">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input asp-for="NewStage.RequiresQualityCheck" class="form-check-input" type="checkbox" checked>
                                        <label asp-for="NewStage.RequiresQualityCheck" class="form-check-label">
                                            Requires Quality Check
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input asp-for="NewStage.RequiresApproval" class="form-check-input" type="checkbox">
                                        <label asp-for="NewStage.RequiresApproval" class="form-check-label">
                                            Requires Approval
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input asp-for="NewStage.AllowSkip" class="form-check-input" type="checkbox">
                                        <label asp-for="NewStage.AllowSkip" class="form-check-label">
                                            Allow Skip
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input asp-for="NewStage.IsOptional" class="form-check-input" type="checkbox">
                                        <label asp-for="NewStage.IsOptional" class="form-check-label">
                                            Optional Stage
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input name="NewStage.AllowParallelExecution" class="form-check-input" type="checkbox">
                                        <label class="form-check-label">
                                            Allow Parallel Execution
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timing & Cost Tab -->
                        <div class="tab-pane fade" id="timing-config" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Default Duration (hours)</label>
                                        <input type="number" name="NewStage.DefaultDurationHours" step="0.1" min="0.1" max="100" class="form-control" value="1.0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label asp-for="NewStage.DefaultSetupMinutes" class="form-label">Setup Time (minutes)</label>
                                        <input asp-for="NewStage.DefaultSetupMinutes" type="number" class="form-control" min="0" max="480" value="30">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label asp-for="NewStage.DefaultHourlyRate" class="form-label">Hourly Rate ($)</label>
                                        <input asp-for="NewStage.DefaultHourlyRate" type="number" step="0.01" class="form-control" min="0" max="500" value="85.00">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Default Material Cost ($)</label>
                                        <input type="number" name="NewStage.DefaultMaterialCost" step="0.01" min="0" class="form-control" value="0.00">
                                        <div class="form-text">Material cost per part for this stage</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Total Estimated Cost</label>
                                        <div class="form-control-plaintext bg-light border rounded p-2" id="totalCostDisplay">
                                            $0.00
                                        </div>
                                        <div class="form-text">Auto-calculated: (Duration × Rate) + (Setup × Rate) + Materials</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Machine Assignment Tab -->
                        <div class="tab-pane fade" id="machine-config" role="tabpanel">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="NewStage.RequiresMachineAssignment" id="requiresMachine" class="form-check-input">
                                    <label for="requiresMachine" class="form-check-label">
                                        <strong>This stage requires specific machine assignment</strong>
                                    </label>
                                </div>
                                <div class="form-text">When enabled, only assigned machines can execute this stage</div>
                            </div>
                            
                            <div id="machineAssignmentConfig" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Machines</label>
                                    <div class="border rounded p-3">
                                        <div class="row" id="machineCheckboxes">
                                            <!-- Machine checkboxes will be loaded here via JavaScript -->
                                            <div class="col-12 text-muted text-center">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Loading available machines...
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" name="NewStage.AssignedMachineIds" id="assignedMachineIds">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Default Machine</label>
                                    <select name="NewStage.DefaultMachineId" id="defaultMachineSelect" class="form-select">
                                        <option value="">No default machine</option>
                                    </select>
                                    <div class="form-text">Preferred machine when multiple options are available</div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Fields Tab -->
                        <div class="tab-pane fade" id="fields-config" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Custom Fields Configuration</h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomField()">
                                    <i class="fas fa-plus me-1"></i>Add Field
                                </button>
                            </div>
            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Custom Fields:</strong> Define stage-specific fields that will be displayed when parts use this stage. 
                                These fields allow capture of stage-specific parameters like temperatures, speeds, materials, etc.
                            </div>
            
                            <div id="customFieldsList">
                                <div class="text-muted text-center py-4" id="noFieldsMessage">
                                    <i class="fas fa-wrench fa-2x mb-2"></i>
                                    <p>No custom fields defined yet.</p>
                                    <p class="small">Custom fields allow you to capture stage-specific information when parts use this stage.</p>
                                </div>
                            </div>
            
                            <input type="hidden" name="NewStage.CustomFieldsConfig" id="customFieldsConfig" value="[]">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="createStageBtn">
                        <i class="fas fa-save me-1"></i>
                        <span class="btn-text">Create Stage</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Additional modals and scripts remain the same as before... -->

@section Scripts {
    <script>
        console.log('?? [STAGES] Loading enhanced production stages page');
        
        // Global variables
        let availableMachines = [];
        let customFields = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('?? [STAGES] Initializing enhanced stage management');
            
            // Load available machines
            loadAvailableMachines();
            
            // Setup event handlers
            setupEventHandlers();
            
            // Initialize tooltips
            if (typeof bootstrap !== 'undefined') {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipTriggerList.forEach(tooltipTriggerEl => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        function setupEventHandlers() {
            // Machine assignment checkbox
            const requiresMachineCheckbox = document.getElementById('requiresMachine');
            if (requiresMachineCheckbox) {
                requiresMachineCheckbox.addEventListener('change', function() {
                    const configDiv = document.getElementById('machineAssignmentConfig');
                    if (configDiv) {
                        configDiv.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }

            // Cost calculation
            const costInputs = ['DefaultDurationHours', 'DefaultSetupMinutes', 'DefaultHourlyRate', 'DefaultMaterialCost'];
            costInputs.forEach(inputName => {
                const input = document.querySelector(`[name="NewStage.${inputName}"]`);
                if (input) {
                    input.addEventListener('input', calculateTotalCost);
                }
            });

            // Initial cost calculation
            calculateTotalCost();
        }

        function calculateTotalCost() {
            try {
                const duration = parseFloat(document.querySelector('[name="NewStage.DefaultDurationHours"]')?.value || 0);
                const setupMinutes = parseFloat(document.querySelector('[name="NewStage.DefaultSetupMinutes"]')?.value || 0);
                const hourlyRate = parseFloat(document.querySelector('[name="NewStage.DefaultHourlyRate"]')?.value || 0);
                const materialCost = parseFloat(document.querySelector('[name="NewStage.DefaultMaterialCost"]')?.value || 0);

                const laborCost = duration * hourlyRate;
                const setupCost = (setupMinutes / 60) * hourlyRate;
                const totalCost = laborCost + setupCost + materialCost;

                const displayElement = document.getElementById('totalCostDisplay');
                if (displayElement) {
                    displayElement.textContent = `$${totalCost.toFixed(2)}`;
                }
            } catch (error) {
                console.warn('Error calculating total cost:', error);
            }
        }

        async function loadAvailableMachines() {
            try {
                const response = await fetch('/api/machines/list');
                if (response.ok) {
                    availableMachines = await response.json();
                    updateMachineCheckboxes();
                    updateDefaultMachineOptions();
                } else {
                    console.warn('Failed to load machines, using fallback data');
                    // Fallback machine data
                    availableMachines = [
                        { id: 'TI1', name: 'TruPrint 3000 #1' },
                        { id: 'TI2', name: 'TruPrint 3000 #2' },
                        { id: 'EDM1', name: 'Sodick AP1L #1' },
                        { id: 'CNC1', name: 'Haas VF-2 #1' }
                    ];
                    updateMachineCheckboxes();
                    updateDefaultMachineOptions();
                }
            } catch (error) {
                console.warn('Error loading machines:', error);
            }
        }

        function updateMachineCheckboxes() {
            const container = document.getElementById('machineCheckboxes');
            if (!container || !availableMachines.length) return;

            const html = availableMachines.map(machine => `
                <div class="col-md-6 mb-2">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input machine-checkbox" 
                               data-machine-id="${machine.id}" id="machine_${machine.id}"
                               onchange="updateAssignedMachines()">
                        <label class="form-check-label" for="machine_${machine.id}">
                            <strong>${machine.id}</strong> - ${machine.name}
                        </label>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updateDefaultMachineOptions() {
            const select = document.getElementById('defaultMachineSelect');
            if (!select || !availableMachines.length) return;

            const html = '<option value="">No default machine</option>' + 
                availableMachines.map(machine => 
                    `<option value="${machine.id}">${machine.id} - ${machine.name}</option>`
                ).join('');

            select.innerHTML = html;
        }

        function updateAssignedMachines() {
            const checkboxes = document.querySelectorAll('.machine-checkbox:checked');
            const assignedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-machine-id'));
            
            const hiddenInput = document.getElementById('assignedMachineIds');
            if (hiddenInput) {
                hiddenInput.value = assignedIds.join(',');
            }

            // Update default machine options to only show assigned machines
            const defaultSelect = document.getElementById('defaultMachineSelect');
            if (defaultSelect) {
                const options = defaultSelect.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value === '') {
                        option.style.display = '';
                    } else {
                        option.style.display = assignedIds.includes(option.value) ? '' : 'none';
                    }
                });
            }
        }

        // Custom field management
        function addCustomField() {
            const fieldId = Date.now();
            const fieldHtml = `
                <div class="card mb-3 custom-field-card" id="customField_${fieldId}">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-wrench me-2 text-primary"></i>
                            Custom Field #${customFields.length + 1}
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCustomField(${fieldId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Field Name *</label>
                                    <input type="text" class="form-control field-name" placeholder="e.g., temperature, speed, material" 
                                           data-field-id="${fieldId}" required>
                                    <div class="form-text">Internal field name (no spaces, lowercase recommended)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Display Label *</label>
                                    <input type="text" class="form-control field-label" placeholder="e.g., Operating Temperature" 
                                           data-field-id="${fieldId}" required>
                                    <div class="form-text">Label shown to users</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Field Type</label>
                                    <select class="form-select field-type" data-field-id="${fieldId}" onchange="updateFieldOptions(${fieldId})">
                                        <option value="text">Text Input</option>
                                        <option value="number">Number Input</option>
                                        <option value="dropdown">Dropdown Selection</option>
                                        <option value="checkbox">Checkbobx</option>
                                        <option value="textarea">Text Area</option>
                                        <option value="date">Date Picker</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Unit (optional)</label>
                                    <input type="text" class="form-control field-unit" placeholder="e.g., °C, mm, %, RPM" 
                                           data-field-id="${fieldId}">
                                    <div class="form-text">Display unit for measurements</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Display Order</label>
                                    <input type="number" class="form-control field-order" min="0" value="${customFields.length}" 
                                           data-field-id="${fieldId}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Default Value</label>
                                    <input type="text" class="form-control field-default" placeholder="Optional default value" 
                                           data-field-id="${fieldId}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Placeholder Text</label>
                                    <input type="text" class="form-control field-placeholder" placeholder="Hint text for users" 
                                           data-field-id="${fieldId}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Description (optional)</label>
                                    <textarea class="form-control field-description" rows="2" 
                                              placeholder="Additional help text for this field" data-field-id="${fieldId}"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mt-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input field-required" data-field-id="${fieldId}">
                                        <label class="form-check-label">Required Field</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input field-readonly" data-field-id="${fieldId}">
                                        <label class="form-check-label">Read Only</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Number field options -->
                        <div id="numberOptions_${fieldId}" class="number-options" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Minimum Value</label>
                                        <input type="number" class="form-control field-min" step="any" data-field-id="${fieldId}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Maximum Value</label>
                                        <input type="number" class="form-control field-max" step="any" data-field-id="${fieldId}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dropdown field options -->
                        <div id="dropdownOptions_${fieldId}" class="dropdown-options" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Dropdown Options *</label>
                                <textarea class="form-control field-options" rows="4" data-field-id="${fieldId}" 
                                          placeholder="Enter one option per line:&#10;Option 1&#10;Option 2&#10;Option 3"></textarea>
                                <div class="form-text">Enter one option per line</div>
                            </div>
                        </div>
                        
                        <!-- Text field options -->
                        <div id="textOptions_${fieldId}" class="text-options" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Validation Pattern (Regex)</label>
                                <input type="text" class="form-control field-pattern" data-field-id="${fieldId}" 
                                       placeholder="e.g., ^[A-Z]{2}[0-9]{4}$ for part numbers">
                                <div class="form-text">Optional regular expression for validation</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('customFieldsList').insertAdjacentHTML('beforeend', fieldHtml);
            customFields.push({ id: fieldId });
            
            // Hide the "no fields" message
            const noFieldsMsg = document.getElementById('noFieldsMessage');
            if (noFieldsMsg) {
                noFieldsMsg.style.display = 'none';
            }
            
            updateCustomFieldsConfig();
        }

        function removeCustomField(fieldId) {
            const element = document.getElementById(`customField_${fieldId}`);
            if (element) {
                element.remove();
                customFields = customFields.filter(f => f.id !== fieldId);
                
                // Show "no fields" message if no fields left
                if (customFields.length === 0) {
                    const noFieldsMsg = document.getElementById('noFieldsMessage');
                    if (noFieldsMsg) {
                        noFieldsMsg.style.display = 'block';
                    }
                }
                
                updateCustomFieldsConfig();
            }
        }

        function updateFieldOptions(fieldId) {
            const typeSelect = document.querySelector(`[data-field-id="${fieldId}"].field-type`);
            const fieldType = typeSelect.value;
            
            // Hide all option panels
            const numberOptions = document.getElementById(`numberOptions_${fieldId}`);
            const dropdownOptions = document.getElementById(`dropdownOptions_${fieldId}`);
            const textOptions = document.getElementById(`textOptions_${fieldId}`);
            
            if (numberOptions) numberOptions.style.display = 'none';
            if (dropdownOptions) dropdownOptions.style.display = 'none';
            if (textOptions) textOptions.style.display = 'none';
            
            // Show relevant option panel
            switch (fieldType) {
                case 'number':
                    if (numberOptions) numberOptions.style.display = 'block';
                    break;
                case 'dropdown':
                    if (dropdownOptions) dropdownOptions.style.display = 'block';
                    break;
                case 'text':
                    if (textOptions) textOptions.style.display = 'block';
                    break;
            }
            
            updateCustomFieldsConfig();
        }

        function updateCustomFieldsConfig() {
            const fields = customFields.map(fieldData => {
                const fieldId = fieldData.id;
                const name = document.querySelector(`[data-field-id="${fieldId}"].field-name`)?.value || '';
                const label = document.querySelector(`[data-field-id="${fieldId}"].field-label`)?.value || '';
                const type = document.querySelector(`[data-field-id="${fieldId}"].field-type`)?.value || 'text';
                const unit = document.querySelector(`[data-field-id="${fieldId}"].field-unit`)?.value || '';
                const displayOrder = parseInt(document.querySelector(`[data-field-id="${fieldId}"].field-order`)?.value) || 0;
                const defaultValue = document.querySelector(`[data-field-id="${fieldId}"].field-default`)?.value || '';
                const placeholderText = document.querySelector(`[data-field-id="${fieldId}"].field-placeholder`)?.value || '';
                const description = document.querySelector(`[data-field-id="${fieldId}"].field-description`)?.value || '';
                const required = document.querySelector(`[data-field-id="${fieldId}"].field-required`)?.checked || false;
                const readOnly = document.querySelector(`[data-field-id="${fieldId}"].field-readonly`)?.checked || false;
                
                // Type-specific options
                let minValue = null;
                let maxValue = null;
                let options = null;
                let validationPattern = null;
                
                if (type === 'number') {
                    const minInput = document.querySelector(`[data-field-id="${fieldId}"].field-min`);
                    const maxInput = document.querySelector(`[data-field-id="${fieldId}"].field-max`);
                    minValue = minInput?.value ? parseFloat(minInput.value) : null;
                    maxValue = maxInput?.value ? parseFloat(maxInput.value) : null;
                } else if (type === 'dropdown') {
                    const optionsText = document.querySelector(`[data-field-id="${fieldId}"].field-options`)?.value || '';
                    options = optionsText ? 
                        optionsText.split('\n').map(opt => opt.trim()).filter(opt => opt.length > 0) : 
                        [];
                } else if (type === 'text') {
                    validationPattern = document.querySelector(`[data-field-id="${fieldId}"].field-pattern`)?.value || null;
                }

                return {
                    Name: name,
                    Label: label,
                    Type: type,
                    Description: description,
                    Required: required,
                    DefaultValue: defaultValue,
                    Options: options,
                    MinValue: minValue,
                    MaxValue: maxValue,
                    ValidationPattern: validationPattern,
                    Unit: unit,
                    DisplayOrder: displayOrder,
                    PlaceholderText: placeholderText,
                    IsReadOnly: readOnly
                };
            }).filter(field => field.Name && field.Label);

            const configInput = document.getElementById('customFieldsConfig');
            if (configInput) {
                configInput.value = JSON.stringify(fields);
            }
        }

        // Edit stage functionality
        async function editStage(stageId) {
            try {
                const response = await fetch(`?handler=StageDetails&stageId=${stageId}`);
                if (!response.ok) throw new Error('Failed to load stage details');
                
                const stage = await response.json();
                
                // Create edit form HTML
                const formHtml = `
                    <form method="post" action="?handler=UpdateStage">
                        <input name="__RequestVerificationToken" type="hidden" value="${$('input[name="__RequestVerificationToken"]').val()}" />
                        <input type="hidden" name="Id" value="${stage.id}" />
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Stage Name *</label>
                                    <input type="text" name="Name" class="form-control" value="${stage.name}" required maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Required Role</label>
                                    <select name="RequiredRole" class="form-select">
                                        <option value="">Any Role</option>
                                        <option value="Operator" ${stage.requiredRole === 'Operator' ? 'selected' : ''}>Operator</option>
                                        <option value="Machinist" ${stage.requiredRole === 'Machinist' ? 'selected' : ''}>Machinist</option>
                                        <option value="EDM Specialist" ${stage.requiredRole === 'EDM Specialist' ? 'selected' : ''}>EDM Specialist</option>
                                        <option value="Finisher" ${stage.requiredRole === 'Finisher' ? 'selected' : ''}>Finisher</option>
                                        <option value="Coater" ${stage.requiredRole === 'Coater' ? 'selected' : ''}>Coater</option>
                                        <option value="Assembler" ${stage.requiredRole === 'Assembler' ? 'selected' : ''}>Assembler</option>
                                        <option value="Quality Inspector" ${stage.requiredRole === 'Quality Inspector' ? 'selected' : ''}>Quality Inspector</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="Description" class="form-control" rows="2" maxlength="500">${stage.description || ''}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Setup Time (minutes)</label>
                                    <input type="number" name="DefaultSetupMinutes" class="form-control" min="0" max="480" value="${stage.defaultSetupMinutes}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Hourly Rate ($)</label>
                                    <input type="number" name="DefaultHourlyRate" step="0.01" class="form-control" min="0" max="500" value="${stage.defaultHourlyRate}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input name="RequiresQualityCheck" class="form-check-input" type="checkbox" ${stage.requiresQualityCheck ? 'checked' : ''}>
                                    <label class="form-check-label">Requires Quality Check</label>
                                </div>
                                <div class="form-check mb-3">
                                    <input name="RequiresApproval" class="form-check-input" type="checkbox" ${stage.requiresApproval ? 'checked' : ''}>
                                    <label class="form-check-label">Requires Approval</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input name="AllowSkip" class="form-check-input" type="checkbox" ${stage.allowSkip ? 'checked' : ''}>
                                    <label class="form-check-label">Allow Skip</label>
                                </div>
                                <div class="form-check mb-3">
                                    <input name="IsOptional" class="form-check-input" type="checkbox" ${stage.isOptional ? 'checked' : ''}>
                                    <label class="form-check-label">Optional Stage</label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                Save Changes
                            </button>
                        </div>
                    </form>
                `;
                
                document.getElementById('editStageForm').innerHTML = formHtml;
                new bootstrap.Modal(document.getElementById('editStageModal')).show();
                
            } catch (error) {
                console.error('Error loading stage details:', error);
                alert('Error loading stage details. Please try again.');
            }
        }

        // Delete stage
        function deleteStage(stageId, stageName) {
            if (confirm(`Are you sure you want to delete the "${stageName}" stage? This action cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '?handler=DeleteStage';
                
                const stageInput = document.createElement('input');
                stageInput.type = 'hidden';
                stageInput.name = 'stageId';
                stageInput.value = stageId;
                
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
                
                form.appendChild(stageInput);
                form.appendChild(tokenInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Create default stages
        function createDefaultStages() {
            if (confirm('This will create default B&T manufacturing stages. Continue?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '?handler=CreateDefaultStages';
                
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
                
                form.appendChild(tokenInput);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}

@section Styles {
    <style>
        .sortable-ghost {
            opacity: 0.4;
            background: #f8f9fa;
        }
        
        .sortable-chosen {
            background: #e3f2fd;
        }
        
        .sortable-drag {
            background: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #sortableStages .list-group-item {
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        #sortableStages .list-group-item:hover {
            background-color: #f8f9fa;
        }
        
        #sortableStages .list-group-item.dragging {
            opacity: 0.8;
            transform: rotate(2deg);
        }
        
        .fas.fa-grip-vertical {
            cursor: grab;
        }
        
        .fas.fa-grip-vertical:active {
            cursor: grabbing;
        }

        .btn.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .custom-field-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .custom-field-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .number-options, .dropdown-options, .text-options {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }
    </style>
}
@page
@model OpCentrix.Pages.PrintTracking.IndexModel
@{
    ViewData["Title"] = "Print Tracking Dashboard";
    Layout = "_Layout";
}

<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Print Tracking</h1>
                        <p class="mt-1 text-sm text-gray-600">Track and log 3D printer operations</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-900">@Model.Dashboard.OperatorName</p>
                            <p class="text-xs text-gray-500">Operator</p>
                        </div>
                        <button onclick="refreshDashboard()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="dashboard-content">
        @await Html.PartialAsync("_PrintTrackingDashboard", Model.Dashboard)
    </div>

    <!-- Quick Action Buttons (Fixed Position) -->
    <div class="fixed bottom-6 right-6 space-y-3">
        <button onclick="openStartPrintModal()" 
                class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200"
                title="Start New Print">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
        </button>
        <button onclick="openPostPrintModal()" 
                class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200"
                title="Complete Print">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Loading Indicator -->
<div id="loading-indicator" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <svg class="animate-spin h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Loading...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Enhanced modal management with better error handling
        function openStartPrintModal(printerName = null) {
            showLoadingIndicator();
            const url = printerName 
                ? `/PrintTracking?handler=StartPrintModal&printerName=${encodeURIComponent(printerName)}`
                : '/PrintTracking?handler=StartPrintModal';
                
            htmx.ajax('GET', url, {
                target: '#modal-container',
                swap: 'innerHTML'
            }).then(() => {
                hideLoadingIndicator();
            }).catch((error) => {
                hideLoadingIndicator();
                handleModalError('Failed to load start print form', error);
            });
        }

        function openPostPrintModal(buildId = null, printerName = null) {
            showLoadingIndicator();
            let url = '/PrintTracking?handler=PostPrintModal';
            const params = [];
            if (buildId) params.push(`buildId=${buildId}`);
            if (printerName) params.push(`printerName=${encodeURIComponent(printerName)}`);
            if (params.length > 0) url += '&' + params.join('&');
            
            htmx.ajax('GET', url, {
                target: '#modal-container',
                swap: 'innerHTML'
            }).then(() => {
                hideLoadingIndicator();
            }).catch((error) => {
                hideLoadingIndicator();
                handleModalError('Failed to load complete print form', error);
            });
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            hideLoadingIndicator();
        }

        function refreshDashboard() {
            showLoadingIndicator();
            htmx.ajax('GET', '/PrintTracking?handler=RefreshDashboard', {
                target: '#dashboard-content',
                swap: 'innerHTML'
            }).then(() => {
                hideLoadingIndicator();
                showToast('Dashboard refreshed successfully', 'success');
            }).catch((error) => {
                hideLoadingIndicator();
                showToast('Failed to refresh dashboard', 'error');
                console.error('Dashboard refresh error:', error);
            });
        }

        // Loading indicator management
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        // Enhanced error handling
        function handleModalError(message, error) {
            console.error('Modal error:', error);
            const errorHtml = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Network Error</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">${message}</p>
                                <p class="text-xs text-gray-400 mt-2">Please check your connection and try again</p>
                            </div>
                            <div class="items-center px-4 py-3 space-y-2">
                                <button onclick="location.reload()" 
                                        class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">
                                    Refresh Page
                                </button>
                                <button onclick="closeModal()" 
                                        class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = errorHtml;
        }

        // Enhanced toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `
                transform transition-all duration-300 translate-x-full
                max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto
                flex ring-1 ring-black ring-opacity-5
            `;
            
            const bgColor = type === 'success' ? 'bg-green-50' : 'bg-red-50';
            const textColor = type === 'success' ? 'text-green-800' : 'text-red-800';
            const iconColor = type === 'success' ? 'text-green-400' : 'text-red-400';
            
            toast.innerHTML = `
                <div class="flex-1 w-0 p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                ${type === 'success' 
                                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-2a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
                                }
                            </svg>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium ${textColor}">${message}</p>
                        </div>
                    </div>
                </div>
                <div class="flex border-l border-gray-200">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="w-full border border-transparent rounded-none rounded-r-lg p-4 flex items-center justify-center text-sm font-medium text-gray-600 hover:text-gray-500">
                        ×
                    </button>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            
            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Enhanced HTMX event handling
        document.body.addEventListener('htmx:beforeRequest', function(event) {
            // Show loading for modal requests
            if (event.detail.requestConfig.headers['HX-Target'] === '#modal-container') {
                showLoadingIndicator();
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(event) {
            hideLoadingIndicator();
            
            // Handle network errors
            if (event.detail.xhr.status >= 400) {
                const isModal = event.detail.requestConfig.headers['HX-Target'] === '#modal-container';
                if (isModal) {
                    handleModalError(`Server error (${event.detail.xhr.status})`, event.detail.xhr);
                } else {
                    showToast(`Request failed (${event.detail.xhr.status})`, 'error');
                }
            }
        });

        document.body.addEventListener('htmx:responseError', function(event) {
            hideLoadingIndicator();
            showToast('Network error. Please check your connection.', 'error');
            console.error('HTMX Response Error:', event.detail);
        });

        document.body.addEventListener('htmx:timeout', function(event) {
            hideLoadingIndicator();
            showToast('Request timed out. Please try again.', 'error');
        });

        // Auto-refresh dashboard every 30 seconds (with error handling)
        setInterval(() => {
            if (!document.getElementById('modal-container').innerHTML) {
                // Only refresh if no modal is open
                htmx.ajax('GET', '/PrintTracking?handler=RefreshDashboard', {
                    target: '#dashboard-content',
                    swap: 'innerHTML'
                }).catch((error) => {
                    console.warn('Auto-refresh failed:', error);
                    // Don't show toast for auto-refresh failures to avoid spam
                });
            }
        }, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape key closes modals
            if (event.key === 'Escape') {
                closeModal();
            }
            // Ctrl+R refreshes dashboard
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                refreshDashboard();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Print Tracking Dashboard initialized');
            
            // Check for any initial errors
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error')) {
                showToast(urlParams.get('error'), 'error');
            }
        });
    </script>
}
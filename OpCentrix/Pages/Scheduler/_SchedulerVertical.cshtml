@using OpCentrix.ViewModels.Scheduler
@model SchedulerPageViewModel
@{
    var slotsPerDay = Model.SlotsPerDay;
    var slotMinutes = Model.SlotMinutes;
    var slotTimes = Enumerable.Range(0, slotsPerDay).Select(i => TimeSpan.FromMinutes(i * slotMinutes)).ToList();
    var totalSlots = Model.Dates.Count * slotsPerDay;
    
    // Get zoom from query string
    var zoom = Context.Request.Query["zoom"].FirstOrDefault() ?? "week";
}

<!-- Task 10: Vertical Scheduler Layout Implementation -->
<div class="scheduler-grid-container scheduler-vertical opcentrix-card" 
     data-zoom="@zoom"
     data-orientation="vertical"
     data-total-slots="@totalSlots">
    
    <!-- Machines Header Row (Horizontal across top) -->
    <div class="scheduler-machines-header">
        <!-- Time column header -->
        <div class="scheduler-time-column scheduler-grid-header bg-white border-b border-r font-bold text-indigo-800">
            <div class="flex items-center justify-center h-full p-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Time
            </div>
        </div>
        
        <!-- Machine columns headers -->
        <div class="scheduler-machine-columns">
            @foreach (var machine in Model.Machines)
            {
                var machineJobs = Model.Jobs.Where(j => j.MachineId == machine).ToList();
                var jobCount = machineJobs.Count;
                
                <div class="machine-column scheduler-grid-header bg-white border-b border-r font-bold text-indigo-800"
                     data-machine="@machine">
                    <div class="flex flex-col items-center justify-center h-full p-2 min-h-[80px]">
                        <div class="text-lg font-bold">@machine</div>
                        <div class="text-xs opacity-75 mt-1">@jobCount job@(jobCount != 1 ? "s" : "")</div>
                        @if (machineJobs.Any())
                        {
                            <div class="text-xs opacity-60">@machineJobs.Sum(j => j.DurationHours).ToString("F1")h</div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
    
    <!-- Time Rows Container -->
    <div class="scheduler-time-rows">
        @for (int d = 0; d < Model.Dates.Count; d++)
        {
            var day = Model.Dates[d];
            for (int s = 0; s < slotsPerDay; s++)
            {
                var slotTime = slotTimes[s];
                var slotDateTime = day.Add(slotTime);
                var isToday = day.Date == DateTime.Today;
                var isCurrentTimeSlot = isToday && 
                    slotTime <= DateTime.Now.TimeOfDay && 
                    slotTime.Add(TimeSpan.FromMinutes(slotMinutes)) > DateTime.Now.TimeOfDay;
                var isWeekend = day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday;
                var isPastWorkHours = slotTime < TimeSpan.FromHours(6) || slotTime >= TimeSpan.FromHours(18);
                
                <!-- Time Row -->
                <div class="time-row flex" data-time="@slotDateTime.ToString("yyyy-MM-ddTHH:mm")">
                    <!-- Time Label -->
                    <div class="scheduler-time-column scheduler-grid-header @(isCurrentTimeSlot ? "bg-blue-50 text-blue-800" : "bg-gray-50 text-gray-700") border-b border-r">
                        <div class="flex items-center justify-center h-full p-2 min-h-[60px]">
                            @if (slotsPerDay == 1)
                            {
                                <div class="text-center">
                                    <div class="font-bold">@day.ToString("ddd")</div>
                                    <div class="text-sm">@day.ToString("M/d")</div>
                                    @if (isToday)
                                    {
                                        <div class="text-xs text-blue-600 font-semibold">Today</div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center">
                                    <div class="text-sm font-medium">@day.ToString("M/d")</div>
                                    <div class="text-xs">
                                        @slotTime.ToString(@"h\:mm")
                                        @if (slotTime.Hours >= 12) 
                                        {
                                            <span>PM</span>
                                        } 
                                        else 
                                        {
                                            <span>AM</span>
                                        }
                                    </div>
                                </div>
                            }
                            @if (isCurrentTimeSlot)
                            {
                                <div class="absolute top-1 right-1 w-2 h-2 bg-blue-600 rounded-full animate-pulse"></div>
                            }
                        </div>
                    </div>
                    
                    <!-- Machine Cells for this time slot -->
                    <div class="scheduler-machine-columns">
                        @foreach (var machine in Model.Machines)
                        {
                            var machineJobs = Model.Jobs.Where(j => j.MachineId == machine).OrderBy(j => j.ScheduledStart).ToList();
                            var cellClasses = new List<string> { 
                                "machine-column", "scheduler-grid-cell", "group", "relative", "cursor-pointer", "border-b", "border-r", "overflow-hidden"
                            };
                            
                            if (isCurrentTimeSlot) cellClasses.Add("current-time");
                            else if (isWeekend) cellClasses.Add("weekend");
                            else if (isPastWorkHours) cellClasses.Add("off-hours");
                            
                            <div class="@string.Join(" ", cellClasses)" 
                                 onclick="openJobModal('@machine', '@slotDateTime.ToString("yyyy-MM-ddTHH:mm")')"
                                 title="Click to add job at @slotDateTime.ToString("MMM dd, yyyy HH:mm")"
                                 data-slot-time="@slotDateTime.ToString("yyyy-MM-ddTHH:mm")"
                                 data-machine="@machine"
                                 style="min-height: 60px; min-width: 150px; max-height: 60px;">
                                 
                                <!-- Jobs in this slot -->
                                @{ 
                                    // Find jobs that overlap with this time slot
                                    var slotEndDateTime = slotDateTime.Add(TimeSpan.FromMinutes(slotMinutes));
                                    var slotJobs = machineJobs.Where(job => 
                                        job.ScheduledStart < slotEndDateTime &&
                                        job.ScheduledEnd > slotDateTime).ToList();
                                }
                                
                                @foreach (var job in slotJobs)
                                {
                                    // Check if this job starts in this slot
                                    var isJobStartSlot = job.ScheduledStart >= slotDateTime && job.ScheduledStart < slotEndDateTime;
                                    
                                    // Check if this job continues from previous slots
                                    var isJobContinuation = job.ScheduledStart < slotDateTime && job.ScheduledEnd > slotDateTime;
                                    
                                    @if (isJobStartSlot || isJobContinuation)
                                    {
                                        // Calculate the portion of the job that appears in this slot
                                        var jobVisibleStart = job.ScheduledStart < slotDateTime ? slotDateTime : job.ScheduledStart;
                                        var jobVisibleEnd = job.ScheduledEnd > slotEndDateTime ? slotEndDateTime : job.ScheduledEnd;
                                        var visibleDurationMinutes = (jobVisibleEnd - jobVisibleStart).TotalMinutes;
                                        var slotFillPercentage = Math.Min(100, (visibleDurationMinutes / slotMinutes) * 100);
                                        
                                        <!-- Job indicator that fits within the cell -->
                                        <div class="absolute job-block @machine.ToLower() status-@job.Status.ToLower().Replace(" ", "-")"
                                             style="top: 2px; left: 2px; right: 2px; height: calc(100% - 4px); max-height: 56px; z-index: 10;"
                                             data-material="@job.SlsMaterial"
                                             data-priority="@job.Priority"
                                             data-status="@job.Status"
                                             onclick="event.stopPropagation(); openJobModal('@machine', '@job.ScheduledStart.ToString("yyyy-MM-ddTHH:mm")', @job.Id)"
                                             title="@job.PartNumber - @job.Status (@job.DurationHours.ToString("F1")h) - @job.SlsMaterial"
                                             data-job-id="@job.Id">
                                            
                                            <!-- Job content that fits in cell -->
                                            <div class="job-block-content p-1">
                                                <div class="job-block-title text-xs truncate">@job.PartNumber</div>
                                                @if (isJobStartSlot)
                                                {
                                                    <!-- Only show full details in starting slot -->
                                                    <div class="job-block-subtitle text-xs truncate opacity-90">
                                                        @if (!string.IsNullOrEmpty(job.SlsMaterial))
                                                        {
                                                            @job.SlsMaterial.Substring(0, Math.Min(job.SlsMaterial.Length, 10))@(job.SlsMaterial.Length > 10 ? "..." : "")
                                                        }
                                                    </div>
                                                    <div class="job-block-meta text-xs flex justify-between">
                                                        <span>@job.DurationHours.ToString("F1")h</span>
                                                        <span>@job.Status</span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <!-- Continuation indicator -->
                                                    <div class="job-block-subtitle text-xs opacity-75">...continues</div>
                                                }
                                            </div>
                                            
                                            <!-- Progress indicator for active jobs -->
                                            @if (job.Status == "Building" || job.Status == "Running")
                                            {
                                                <div class="absolute bottom-0 left-0 h-1 bg-white bg-opacity-40 rounded-b" 
                                                     style="width: @(slotFillPercentage)%;"></div>
                                            }
                                            
                                            <!-- Visual indicator for job continuation -->
                                            @if (isJobContinuation && !isJobStartSlot)
                                            {
                                                <div class="absolute top-0 left-0 w-full h-1 bg-white bg-opacity-60"></div>
                                            }
                                            @if (job.ScheduledEnd > slotEndDateTime)
                                            {
                                                <div class="absolute bottom-0 left-0 w-full h-1 bg-white bg-opacity-60"></div>
                                            }
                                        </div>
                                    }
                                }
                                
                                <!-- Enhanced Add Job button for vertical layout -->
                                @if (!slotJobs.Any())
                                {
                                    <div class="absolute z-20 top-2 right-2 opacity-0 group-hover:opacity-100 transition-all duration-300 
                                                bg-indigo-600 text-white rounded-full w-6 h-6 text-xs font-bold shadow-lg 
                                                hover:bg-indigo-700 hover:scale-110 flex items-center justify-center pointer-events-none
                                                transform group-hover:scale-100 scale-90">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </div>
                                }
                                
                                <!-- Time indicator for current slot -->
                                @if (isCurrentTimeSlot)
                                {
                                    <div class="absolute top-1 left-1 w-2 h-2 bg-blue-600 rounded-full animate-pulse z-30"></div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>